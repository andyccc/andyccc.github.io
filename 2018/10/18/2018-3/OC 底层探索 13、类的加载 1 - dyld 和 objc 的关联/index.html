

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="andyccc">
  <meta name="keywords" content="">
  
  <title>类的加载 1 - dyld 和 objc 的关联 - andyccc</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>andyccc</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="类的加载 1 - dyld 和 objc 的关联">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2018-10-18 23:07" pubdate>
        2018年10月18日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      81
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">类的加载 1 - dyld 和 objc 的关联</h1>
            
            <div class="markdown-body">
              <p>本文开始探索类的加载。<a target="_blank" rel="noopener" href="https://github.com/andyccc/objc">调试源码 objc 源码工程</a></p>
<p>_objc_init 函数：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs markdown">1 /<span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 2 *</span> <span class="hljs-emphasis">_objc_</span>init</span><br><span class="hljs-strong"> 3 <span class="hljs-emphasis">* Bootstrap initialization. Registers our image notifier with dyld.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 4 *</span> Called by libSystem BEFORE library initialization time</span><br><span class="hljs-strong"> 5 **</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>/<br> 7 void <span class="hljs-emphasis">_objc_</span>init(void)<br> 8 &#123;<br> 9     static bool initialized = false;<br>10     if (initialized) return;<br>11     initialized = true;<br>13     // fixme defer initialization until an objc-using image is found?<br>14     environ<span class="hljs-emphasis">_init();</span><br><span class="hljs-emphasis">15     tls_</span>init();<br>16     static<span class="hljs-emphasis">_init();</span><br><span class="hljs-emphasis">17     runtime_</span>init();<br>18     exception<span class="hljs-emphasis">_init();</span><br><span class="hljs-emphasis">19     cache_</span>init();<br>20     <span class="hljs-emphasis">_imp_</span>implementationWithBlock<span class="hljs-emphasis">_init();</span><br><span class="hljs-emphasis">22     _</span>dyld<span class="hljs-emphasis">_objc_</span>notify<span class="hljs-emphasis">_register(&amp;map_</span>images, load<span class="hljs-emphasis">_images, unmap_</span>image);<br>24 #if <span class="hljs-strong">__OBJC2__</span><br>25     didCallDyldNotifyRegister = true;<br>26 #endif<br>27 &#125;<br></code></pre></td></tr></table></figure>



<h2 id="一、各-init-初始化的简单了解"><a href="#一、各-init-初始化的简单了解" class="headerlink" title="一、各 init 初始化的简单了解"></a>一、各 init 初始化的简单了解</h2><h3 id="1）环境变量的初始化与简单使用"><a href="#1）环境变量的初始化与简单使用" class="headerlink" title="1）环境变量的初始化与简单使用"></a>1）环境变量的初始化与简单使用</h3><p>我们从 14 行 <strong>environ_init()</strong> 环境变量初始化开始进行探究。</p>
<p>environ_init() 函数：</p>
<p>读取影响运行时的环境变量</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-number">1</span> <span class="hljs-comment">/***********************************************************************</span><br><span class="hljs-comment"> 2 * environ_init</span><br><span class="hljs-comment"> 3 * Read environment variables that affect the runtime.</span><br><span class="hljs-comment"> 4 * Also print environment variable help, if requested.</span><br><span class="hljs-comment"> 5 **********************************************************************/</span><br> <span class="hljs-number">6</span> void environ<span class="hljs-constructor">_init(<span class="hljs-params">void</span>)</span> <br> <span class="hljs-number">7</span> &#123;<br> <span class="hljs-number">8</span>     <span class="hljs-keyword">if</span> (issetugid<span class="hljs-literal">()</span>) &#123;<br> <span class="hljs-number">9</span>         <span class="hljs-comment">// All environment variables are silently ignored when setuid or setgid</span><br><span class="hljs-number">10</span>         <span class="hljs-comment">// This includes OBJC_HELP and OBJC_PRINT_OPTIONS themselves.</span><br><span class="hljs-number">11</span>         return;<br><span class="hljs-number">12</span>     &#125; <br><span class="hljs-number">14</span>     <span class="hljs-built_in">bool</span> PrintHelp = <span class="hljs-literal">false</span>;<br><span class="hljs-number">15</span>     <span class="hljs-built_in">bool</span> PrintOptions = <span class="hljs-literal">false</span>;<br><span class="hljs-number">16</span>     <span class="hljs-built_in">bool</span> maybeMallocDebugging = <span class="hljs-literal">false</span>;<br><span class="hljs-number">18</span>     <span class="hljs-comment">// Scan environ[] directly instead of calling getenv() a lot.</span><br><span class="hljs-number">19</span>     <span class="hljs-comment">// This optimizes the case where none are set.</span><br><span class="hljs-number">20</span>     <span class="hljs-keyword">for</span> (<span class="hljs-built_in">char</span> **p = *<span class="hljs-constructor">_NSGetEnviron()</span>; *p != nil; p++) &#123;<br><span class="hljs-number">21</span>             ...... <span class="hljs-comment">// 代码不全部展示了 </span><br><span class="hljs-number">22</span>     &#125;<br><span class="hljs-number">24</span>     <span class="hljs-comment">// Special case: enable some autorelease pool debugging </span><br><span class="hljs-number">25</span>     <span class="hljs-comment">// when some malloc debugging is enabled </span><br><span class="hljs-number">26</span>     <span class="hljs-comment">// and OBJC_DEBUG_POOL_ALLOCATION is not set to something other than NO.</span><br><span class="hljs-number">27</span>     <span class="hljs-keyword">if</span> (maybeMallocDebugging) &#123;<br><span class="hljs-number">28</span>         ...... <span class="hljs-comment">// 代码不全部展示了</span><br><span class="hljs-number">29</span>     &#125;<br><span class="hljs-number">31</span>     <span class="hljs-comment">// Print OBJC_HELP and OBJC_PRINT_OPTIONS output.</span><br><span class="hljs-number">32</span>     <span class="hljs-keyword">if</span> (PrintHelp<span class="hljs-operator">  ||  </span>PrintOptions) &#123;<br><span class="hljs-number">33</span>         <span class="hljs-keyword">if</span> (PrintHelp) &#123;<br><span class="hljs-number">34</span>             <span class="hljs-constructor">_objc_inform(<span class="hljs-string">&quot;Objective-C runtime debugging. Set variable=YES to enable.&quot;</span>)</span>;<br><span class="hljs-number">35</span>             <span class="hljs-constructor">_objc_inform(<span class="hljs-string">&quot;OBJC_HELP: describe available environment variables&quot;</span>)</span>;<br><span class="hljs-number">36</span>             <span class="hljs-keyword">if</span> (PrintOptions) &#123;<br><span class="hljs-number">37</span>                 <span class="hljs-constructor">_objc_inform(<span class="hljs-string">&quot;OBJC_HELP is set&quot;</span>)</span>;<br><span class="hljs-number">38</span>             &#125;<br><span class="hljs-number">39</span>             <span class="hljs-constructor">_objc_inform(<span class="hljs-string">&quot;OBJC_PRINT_OPTIONS: list which options are set&quot;</span>)</span>;<br><span class="hljs-number">40</span>         &#125;<br><span class="hljs-number">41</span>         <span class="hljs-keyword">if</span> (PrintOptions) &#123;<br><span class="hljs-number">42</span>             <span class="hljs-constructor">_objc_inform(<span class="hljs-string">&quot;OBJC_PRINT_OPTIONS is set&quot;</span>)</span>;<br><span class="hljs-number">43</span>         &#125;<br><span class="hljs-number">45</span>         <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; sizeof(Settings)/sizeof(Settings<span class="hljs-literal">[<span class="hljs-number">0</span>]</span>); i++) &#123;<br><span class="hljs-number">46</span>             const option_t *opt = &amp;Settings<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span>;            <br><span class="hljs-number">47</span>             <span class="hljs-keyword">if</span> (PrintHelp) <span class="hljs-constructor">_objc_inform(<span class="hljs-string">&quot;%s: %s&quot;</span>, <span class="hljs-params">opt</span>-&gt;<span class="hljs-params">env</span>, <span class="hljs-params">opt</span>-&gt;<span class="hljs-params">help</span>)</span>;<br><span class="hljs-number">48</span>             <span class="hljs-keyword">if</span> (PrintOptions<span class="hljs-operator"> &amp;&amp; </span>*opt-&gt;var) <span class="hljs-constructor">_objc_inform(<span class="hljs-string">&quot;%s is set&quot;</span>, <span class="hljs-params">opt</span>-&gt;<span class="hljs-params">env</span>)</span>;<br><span class="hljs-number">49</span>         &#125;<br><span class="hljs-number">50</span>     &#125;<br><span class="hljs-number">52</span>     <span class="hljs-comment">// 我加的调试代码</span><br><span class="hljs-number">53</span>     <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; sizeof(Settings)/sizeof(Settings<span class="hljs-literal">[<span class="hljs-number">0</span>]</span>); i++) &#123;<br><span class="hljs-number">54</span>         const option_t *opt = &amp;Settings<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span>;<br><span class="hljs-number">55</span>         <span class="hljs-constructor">_objc_inform(<span class="hljs-string">&quot;%s: %s&quot;</span>, <span class="hljs-params">opt</span>-&gt;<span class="hljs-params">env</span>, <span class="hljs-params">opt</span>-&gt;<span class="hljs-params">help</span>)</span>;<br><span class="hljs-number">56</span>         <span class="hljs-constructor">_objc_inform(<span class="hljs-string">&quot;%s is set&quot;</span>, <span class="hljs-params">opt</span>-&gt;<span class="hljs-params">env</span>)</span>;<br><span class="hljs-number">57</span>     &#125;<br><span class="hljs-number">58</span> &#125;<br></code></pre></td></tr></table></figure>



<p>我们通过运行工程 (objc 源码工程)，发现上述代码都没有走进去，把打印输出提取出来(52 行) 再次运行，可看到输出信息如下(信息比较长截取部分)：</p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018123349272-1017030560.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="环境变量的使用"><a href="#环境变量的使用" class="headerlink" title="环境变量的使用"></a>环境变量的使用</h3><p>上图输出结果倒数 4 行，我们看到是 <strong>OBJC_DISABLE_NONPOINTER_ISA</strong> 是 isa 的设置，我们在工程中 Edit Scheme 中添加此属性，如下图：</p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018123743932-1568502516.png" srcset="/img/loading.gif" lazyload> </p>
<p>main.m 中创建一个 MYPerson，不同场景运行工程结果如下：</p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018131543337-1458825048.png" srcset="/img/loading.gif" lazyload></p>
<p>我们可通过环境换量的设置，更便捷的对工程有整体的了解。</p>
<p>更直观的，我们添加 OBJC_PRINT_LOAD_METHODS : YES</p>
<p>注释掉上述调试代码 (52~57)，再次运行，所有的 load 方法都输出了，如下：</p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018132242405-1236033854.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2）tls-init"><a href="#2）tls-init" class="headerlink" title="2）tls_init() -"></a>2）tls_init() -</h3><p>关于线程 key 的绑定 - 例如现成的析构函数。(runloop / 自动释放池等都依赖于线程)</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">1 </span>void tls_init(void)<br><span class="hljs-symbol">2 </span>&#123;<br><span class="hljs-symbol">3 </span>#<span class="hljs-keyword">if</span> SUPPORT_DIRECT_THREAD_KEYS<br><span class="hljs-symbol">4 </span>    pthread_key_init_np(TLS_DIRECT_KEY, &amp;_objc_pthread_destroyspecific);<br><span class="hljs-symbol">5 </span>#<span class="hljs-keyword">else</span><br><span class="hljs-symbol">6 </span>    _objc_pthread_key = tls_create(&amp;_objc_pthread_destroyspecific);<br><span class="hljs-symbol">7 </span>#endif<br><span class="hljs-symbol">8 </span>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="static-init-objc-中的静态构造函数"><a href="#static-init-objc-中的静态构造函数" class="headerlink" title="static_init() - objc 中的静态构造函数"></a>static_init() - objc 中的静态构造函数</h3><p>运行 C++ 静态构造函数，它们的调用会比 dyld 还早。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">1 /<span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 2 *</span> static<span class="hljs-emphasis">_init</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 3 * Run C++ static constructor functions.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 4 * libc calls _</span>objc<span class="hljs-emphasis">_init() before dyld would call our static constructors, </span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 5 * so we have to do it ourselves.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 6 <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**/</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"> 7 static void static<span class="hljs-emphasis">_init()</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"> 8 &#123;</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"> 9     size_</span>t count;</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">10     auto inits = getLibobjcInitializers(&amp;<span class="hljs-emphasis">_mh_</span>dylib<span class="hljs-emphasis">_header, &amp;count);</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">11     for (size_</span>t i = 0; i &lt; count; i++) &#123;</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">12         inits[<span class="hljs-string">i</span>](<span class="hljs-link"></span>);</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">13     &#125;</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">14 &#125;</span></span></span><br></code></pre></td></tr></table></figure>



<h3 id="runtime-init"><a href="#runtime-init" class="headerlink" title="runtime_init()"></a>runtime_init()</h3><p>runtime 运行时环境初始化</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">1 </span>void runtime_init(void)<br><span class="hljs-symbol">2 </span>&#123;<br><span class="hljs-symbol">3 </span>    objc::unattachedCategories.init(<span class="hljs-number">32</span>);// 分类处理的初始化<br><span class="hljs-symbol">4 </span>    objc::allocatedClasses.init();// 表 用来储存加载的类<br><span class="hljs-symbol">5 </span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="exception-init-异常"><a href="#exception-init-异常" class="headerlink" title="exception_init() - 异常"></a>exception_init() - 异常</h3><p>初始化 libobjc 的异常处理系统。</p>
<p>crash 系统抛出异常，程序中断</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">1 </span>/***********************************************************************<br><span class="hljs-symbol">2 </span>* exception_init<br><span class="hljs-symbol">3 </span>* Initialize libobjc<span class="hljs-comment">&#x27;s exception handling system.</span><br><span class="hljs-symbol">4 </span>* Called by map_images().<br><span class="hljs-symbol">5 </span>**********************************************************************/<br><span class="hljs-symbol">6 </span>void exception_init(void)<br><span class="hljs-symbol">7 </span>&#123;<br><span class="hljs-symbol">8 </span>    old_terminate = std::set_terminate(&amp;_objc_terminate);<br><span class="hljs-symbol">9 </span>&#125;<br></code></pre></td></tr></table></figure>





<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs markdown">1 /<span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 2 *</span> <span class="hljs-emphasis">_objc_</span>terminate</span><br><span class="hljs-strong"> 3 <span class="hljs-emphasis">* Custom std::terminate handler.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 4 *</span></span><br><span class="hljs-strong"> 5 <span class="hljs-emphasis">* The uncaught exception callback is implemented as a std::terminate handler. </span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 6 *</span> 1. Check if there&#x27;s an active exception</span><br><span class="hljs-strong"> 7 <span class="hljs-emphasis">* 2. If so, check if it&#x27;s an Objective-C exception</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 8 *</span> 3. If so, call our registered callback with the object.</span><br><span class="hljs-strong"> 9 <span class="hljs-emphasis">* 4. Finally, call the previous terminate handler.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">10 <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**/</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">11 static void (<span class="hljs-emphasis">*old_terminate)(void) = nil;</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">12 static void _objc_terminate(void)</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">13 &#123;</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">14     if (PrintExceptions) &#123;</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">15         _objc_inform(&quot;EXCEPTIONS: terminating&quot;);</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">16     &#125;</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">18     if (! <span class="hljs-strong">__cxa<span class="hljs-emphasis">_current_</span>exception<span class="hljs-emphasis">_type()) &#123;</span></span></span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">19         // No current exception.</span></span></span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">20         (*old_</span>terminate)();</span></span></span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">21     &#125;</span></span></span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">22     else &#123;</span></span></span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">23         // There is a current exception. Check if it&#x27;s an objc exception.</span></span></span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">24         @try &#123;</span></span></span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">25             __</span>cxa_rethrow();</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">26         &#125; @catch (id e) &#123;</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">27             // It&#x27;s an objc object. Call Foundation&#x27;s handler, if any. 句柄 函数回调 - 截取异常</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">28             (*</span>uncaught<span class="hljs-emphasis">_handler)((id)e);</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">29             (*old_</span>terminate)();</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">30         &#125; @catch (...) &#123;</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">31             // It&#x27;s not an objc object. Continue to C++ terminate.</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">32             (<span class="hljs-emphasis">*old_terminate)();</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">33         &#125;</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">34     &#125;</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">35 &#125;</span></span></span></span><br></code></pre></td></tr></table></figure>



<h3 id="cache-init"><a href="#cache-init" class="headerlink" title="cache_init()"></a>cache_init()</h3><p>缓存条件初始化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-number">1</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cache_init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"> 2 </span>&#123;<br> <span class="hljs-number">3</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> HAVE_TASK_RESTARTABLE_RANGES</span><br> <span class="hljs-number">4</span>     <span class="hljs-keyword">mach_msg_type_number_t</span> count = <span class="hljs-number">0</span>;<br> <span class="hljs-number">5</span>     <span class="hljs-keyword">kern_return_t</span> kr;<br> <span class="hljs-number">7</span>     <span class="hljs-keyword">while</span> (objc_restartableRanges[count].location) &#123;<br> <span class="hljs-number">8</span>         count++;<br> <span class="hljs-number">9</span>     &#125;<br><span class="hljs-number">11</span>     kr = <span class="hljs-built_in">task_restartable_ranges_register</span>(<span class="hljs-built_in">mach_task_self</span>(),<br><span class="hljs-number">12</span>                                           objc_restartableRanges, count);<br><span class="hljs-number">13</span>     <span class="hljs-keyword">if</span> (kr == KERN_SUCCESS) <span class="hljs-keyword">return</span>;<br><span class="hljs-number">14</span>     _objc_fatal(<span class="hljs-string">&quot;task_restartable_ranges_register failed (result 0x%x: %s)&quot;</span>,<br><span class="hljs-number">15</span>                 kr, <span class="hljs-built_in">mach_error_string</span>(kr));<br><span class="hljs-number">16</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">// HAVE_TASK_RESTARTABLE_RANGES</span></span><br><span class="hljs-number">17</span> &#125;<br></code></pre></td></tr></table></figure>



<h3 id="imp-implementationWithBlock-init"><a href="#imp-implementationWithBlock-init" class="headerlink" title="_imp_implementationWithBlock_init()"></a>_imp_implementationWithBlock_init()</h3><p>启用回调机制。通常情况下不做什么操作，因为所有的初始化都是懒加载的，但对于某些进程，迫切的需要加载 trampolines dylib.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-number">1</span> <span class="hljs-comment">/// Initialize the trampoline machinery. Normally this does nothing, as</span><br> <span class="hljs-number">2</span> <span class="hljs-comment">/// everything is initialized lazily, but for certain processes we eagerly load  3 /// the trampolines dylib.</span><br> <span class="hljs-number">4</span> <span class="hljs-keyword">void</span><br> <span class="hljs-number">5</span> _imp_implementationWithBlock_init(<span class="hljs-keyword">void</span>)<br> <span class="hljs-number">6</span> &#123;<br> <span class="hljs-number">7</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> TARGET_OS_OSX</span><br> <span class="hljs-number">8</span>     <span class="hljs-comment">// Eagerly load libobjc-trampolines.dylib in certain processes. Some</span><br> <span class="hljs-number">9</span>     <span class="hljs-comment">// programs (most notably QtWebEngineProcess used by older versions of</span><br><span class="hljs-number">10</span>     <span class="hljs-comment">// embedded Chromium) enable a highly restrictive sandbox profile which</span><br><span class="hljs-number">11</span>     <span class="hljs-comment">// blocks access to that dylib. If anything calls</span><br><span class="hljs-number">12</span>     <span class="hljs-comment">// imp_implementationWithBlock (as AppKit has started doing) then we&#x27;ll</span><br><span class="hljs-number">13</span>     <span class="hljs-comment">// crash trying to load it. Loading it here sets it up before the sandbox</span><br><span class="hljs-number">14</span>     <span class="hljs-comment">// profile is enabled and blocks it.</span><br><span class="hljs-number">15</span>     <span class="hljs-comment">//</span><br><span class="hljs-number">16</span>     <span class="hljs-comment">// This fixes EA Origin (rdar://problem/50813789)</span><br><span class="hljs-number">17</span>     <span class="hljs-comment">// and Steam (rdar://problem/55286131)</span><br><span class="hljs-number">18</span>     <span class="hljs-keyword">if</span> (__progname &amp;&amp;<br><span class="hljs-number">19</span>         (<span class="hljs-built_in">strcmp</span>(__progname, <span class="hljs-string">&quot;QtWebEngineProcess&quot;</span>) == <span class="hljs-number">0</span> ||<br><span class="hljs-number">20</span>          <span class="hljs-built_in">strcmp</span>(__progname, <span class="hljs-string">&quot;Steam Helper&quot;</span>) == <span class="hljs-number">0</span>)) &#123;<br><span class="hljs-number">21</span>         Trampolines.<span class="hljs-built_in">Initialize</span>();<br><span class="hljs-number">22</span>     &#125;<br><span class="hljs-number">23</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-number">24</span> &#125;<br></code></pre></td></tr></table></figure>



<h2 id="二、-dyld-objc-notify-register"><a href="#二、-dyld-objc-notify-register" class="headerlink" title="二、_dyld_objc_notify_register() - "></a>二、_dyld_objc_notify_register() - </h2><p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018142229936-1774839960.png" srcset="/img/loading.gif" lazyload> </p>
<p>代码 –&gt; 编译 –&gt; machO –&gt; 内存</p>
<p>把 macho 各式各样数据加载到内存中，如何加载？–&gt; map_images 镜像文件装载到内存 </p>
<p>_dyld_objc_notify_register() 是 dyld 库 的调用 (跨库，实现在 dyld 库中)。</p>
<p>执行流程：<strong>dyld 中 从 dyld_start 开始 –&gt; 一系列操作 –&gt; 跳 objc 中 处理完成 –&gt; 回到 dyld 中继续执行 –&gt; main 入口</strong>。 具体流程可见 <a href="">OC 底层探索 12</a>.</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-number">1</span> <span class="hljs-comment">/**</span><br><span class="hljs-comment"> 2     mapped -- &amp;map_images</span><br><span class="hljs-comment"> 3     init -- load_images</span><br><span class="hljs-comment"> 4 */</span><br> <span class="hljs-number">5</span> void <span class="hljs-variable">_dyld_objc_notify_register</span>(<span class="hljs-variable">_dyld_objc_notify_mapped</span>    mapped,<br> <span class="hljs-number">6</span>                                 <span class="hljs-variable">_dyld_objc_notify_init</span>      init,<br> <span class="hljs-number">7</span>                                 <span class="hljs-variable">_dyld_objc_notify_unmapped</span>  unmapped)<br> <span class="hljs-number">8</span> &#123;<br> <span class="hljs-number">9</span>     <span class="hljs-keyword">if</span> ( gUseDyld3 )<br><span class="hljs-number">10</span>         return dyld3::<span class="hljs-variable">_dyld_objc_notify_register</span>(mapped, init, unmapped);<br><span class="hljs-number">12</span>     DYLD_LOCK_THIS_BLOCK;<br><span class="hljs-number">13</span>     static bool (*p)(<span class="hljs-variable">_dyld_objc_notify_mapped</span>, <span class="hljs-variable">_dyld_objc_notify_init</span>, <span class="hljs-variable">_dyld_objc_notify_unmapped</span>) = NULL;<br><span class="hljs-number">15</span>     <span class="hljs-keyword">if</span>(p == NULL)<br><span class="hljs-number">16</span>         <span class="hljs-variable">_dyld_func_lookup</span>(<span class="hljs-string">&quot;__dyld_objc_notify_register&quot;</span>, (void**)&amp;p);<br><span class="hljs-number">17</span>     p(mapped, init, unmapped);<br><span class="hljs-number">18</span> &#125;<br></code></pre></td></tr></table></figure>



<p>map_images / load_images / unmap_image 何时调:</p>
<p><strong>dyld:</strong> </p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-number">1</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">registerObjCNotifiers</span><span class="hljs-params">(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)</span></span><br><span class="hljs-function"> 2 </span>&#123;<br> <span class="hljs-number">3</span>     <span class="hljs-comment">// record functions to call</span><br> <span class="hljs-number">4</span>     sNotifyObjCMapped = mapped;  <span class="hljs-number">5</span>     sNotifyObjCInit = init;  <span class="hljs-number">6</span>     sNotifyObjCUnmapped = unmapped;  <span class="hljs-number">7</span> <br> <span class="hljs-number">8</span>     <span class="hljs-comment">// call &#x27;mapped&#x27; function with all images mapped so far</span><br> <span class="hljs-number">9</span>     <span class="hljs-keyword">try</span> &#123;<br><span class="hljs-number">10</span>         <span class="hljs-built_in">notifyBatchPartial</span>(dyld_image_state_bound, <span class="hljs-literal">true</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br><span class="hljs-number">11</span>     &#125;<br><span class="hljs-number">12</span>     <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* msg) &#123;<br><span class="hljs-number">13</span>         <span class="hljs-comment">// ignore request to abort during registration</span><br><span class="hljs-number">14</span>     &#125;<br><span class="hljs-number">16</span>     <span class="hljs-comment">// &lt;rdar://problem/32209809&gt; call &#x27;init&#x27; function on all images already init&#x27;ed (below libSystem)</span><br><span class="hljs-number">17</span>     <span class="hljs-keyword">for</span> (std::vector&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class="hljs-built_in">begin</span>(); it != sAllImages.<span class="hljs-built_in">end</span>(); it++) &#123;<br><span class="hljs-number">18</span>         ImageLoader* image = *it;<br><span class="hljs-number">19</span>         <span class="hljs-keyword">if</span> ( (image-&gt;<span class="hljs-built_in">getState</span>() == dyld_image_state_initialized) &amp;&amp; image-&gt;<span class="hljs-built_in">notifyObjC</span>() ) &#123;<br><span class="hljs-number">20</span>             <span class="hljs-function">dyld3::ScopedTimer <span class="hljs-title">timer</span><span class="hljs-params">(DBG_DYLD_TIMING_OBJC_INIT, (<span class="hljs-keyword">uint64_t</span>)image-&gt;machHeader(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;<br><span class="hljs-number">21</span>             (*sNotifyObjCInit)(image-&gt;<span class="hljs-built_in">getRealPath</span>(), image-&gt;<span class="hljs-built_in">machHeader</span>()); <span class="hljs-number">22</span>         &#125;<br><span class="hljs-number">23</span>     &#125;<br><span class="hljs-number">24</span> &#125;<br></code></pre></td></tr></table></figure>



<p><strong>sNotifyObjCMapped</strong> –&gt; *<em>notifyBatchPartial() : (<em>sNotifyObjCMapped)(objcImageCount, paths, mhs);</em></em></p>
<p><strong>sNotifyObjCInit</strong> –&gt; *<em>notifySingle() : (<em>sNotifyObjCInit)(image-&gt;getRealPath(), image-&gt;machHeader());</em></em></p>
<p><strong>sNotifyObjCUnmapped</strong> –&gt; *<em>removeImage() : (<em>sNotifyObjCUnmapped)(image-&gt;getRealPath(), image-&gt;machHeader());</em></em></p>
<h3 id="1）map-images"><a href="#1）map-images" class="headerlink" title="1）map_images"></a>1）map_images</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">1 /<span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 2 *</span> map<span class="hljs-emphasis">_images</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 3 * Process the given images which are being mapped in by dyld.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 4 * Calls ABI-agnostic code after taking ABI-specific locks.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 5 *</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 6 * Locking: write-locks runtimeLock</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 7 <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**/</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"> 8 void</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"> 9 map<span class="hljs-emphasis">_images(unsigned count, const char * const paths[],</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">10            const struct mach_</span>header <span class="hljs-emphasis">* const mhdrs[])</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">11 &#123;</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">12     mutex_locker_t lock(runtimeLock);</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">13     return map_images_nolock(count, paths, mhdrs);</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">14 &#125;</span></span></span></span><br></code></pre></td></tr></table></figure>



<p>跳到 map_images_nolock() 实现: </p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018151527890-1733268486.png" srcset="/img/loading.gif" lazyload></p>
<p>**_read_images()**：代码比较长</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-number">1</span> <span class="hljs-comment">/***********************************************************************</span><br><span class="hljs-comment">  2 * _read_images</span><br><span class="hljs-comment">  3 * Perform initial processing of the headers in the linked </span><br><span class="hljs-comment">  4 * list beginning with headerList. </span><br><span class="hljs-comment">  5 *</span><br><span class="hljs-comment">  6 * Called by: map_images_nolock</span><br><span class="hljs-comment">  7 *</span><br><span class="hljs-comment">  8 * Locking: runtimeLock acquired by map_images</span><br><span class="hljs-comment">  9 **********************************************************************/</span><br> <span class="hljs-number">10</span> <span class="hljs-keyword">void</span> _read_images(header_info **hList, <span class="hljs-keyword">uint32_t</span> hCount, <span class="hljs-keyword">int</span> totalClasses, <span class="hljs-keyword">int</span> unoptimizedTotalClasses)<br> <span class="hljs-number">11</span> &#123;<br> <span class="hljs-number">12</span>     header_info *hi;<br> <span class="hljs-number">13</span>     <span class="hljs-keyword">uint32_t</span> hIndex;<br> <span class="hljs-number">14</span>     <span class="hljs-keyword">size_t</span> count;<br> <span class="hljs-number">15</span>     <span class="hljs-keyword">size_t</span> i;<br> <span class="hljs-number">16</span>     Class *resolvedFutureClasses = nil;<br> <span class="hljs-number">17</span>     <span class="hljs-keyword">size_t</span> resolvedFutureClassCount = <span class="hljs-number">0</span>;<br> <span class="hljs-number">18</span>     <span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> doneOnce;<br> <span class="hljs-number">19</span>     <span class="hljs-keyword">bool</span> launchTime = NO;<br> <span class="hljs-number">20</span>     <span class="hljs-function">TimeLogger <span class="hljs-title">ts</span><span class="hljs-params">(PrintImageTimes)</span></span>;<br> <span class="hljs-number">22</span>     runtimeLock.<span class="hljs-built_in">assertLocked</span>();<br> <span class="hljs-number">24</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> EACH_HEADER \</span><br><span class="hljs-meta"> 25     hIndex = 0;         \</span><br><span class="hljs-meta"> 26     hIndex &lt; hCount &amp;&amp; (hi = hList[hIndex]); \</span><br><span class="hljs-meta"> 27     hIndex++</span><br> <span class="hljs-number">29</span>     <span class="hljs-keyword">if</span> (!doneOnce) &#123;<br> <span class="hljs-number">30</span>         doneOnce = YES;<br> <span class="hljs-number">31</span>         launchTime = YES;<br> <span class="hljs-number">33</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> SUPPORT_NONPOINTER_ISA</span><br> <span class="hljs-number">34</span>         <span class="hljs-comment">// Disable non-pointer isa under some conditions.</span><br> <span class="hljs-number">36</span> <span class="hljs-meta"># <span class="hljs-meta-keyword">if</span> SUPPORT_INDEXED_ISA</span><br> <span class="hljs-number">37</span>         <span class="hljs-comment">// Disable nonpointer isa if any image contains old Swift code</span><br> <span class="hljs-number">38</span>         <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br> <span class="hljs-number">39</span>             <span class="hljs-keyword">if</span> (hi-&gt;<span class="hljs-built_in">info</span>()-&gt;<span class="hljs-built_in">containsSwift</span>()  &amp;&amp;<br> <span class="hljs-number">40</span>                 hi-&gt;<span class="hljs-built_in">info</span>()-&gt;<span class="hljs-built_in">swiftUnstableVersion</span>() &lt; objc_image_info::SwiftVersion3)<br> <span class="hljs-number">41</span>             &#123;<br> <span class="hljs-number">42</span>                 DisableNonpointerIsa = <span class="hljs-literal">true</span>;<br> <span class="hljs-number">43</span>                 <span class="hljs-keyword">if</span> (PrintRawIsa) &#123;<br> <span class="hljs-number">44</span>                     _objc_inform(<span class="hljs-string">&quot;RAW ISA: disabling non-pointer isa because &quot;</span><br> <span class="hljs-number">45</span>                                  <span class="hljs-string">&quot;the app or a framework contains Swift code &quot;</span><br> <span class="hljs-number">46</span>                                  <span class="hljs-string">&quot;older than Swift 3.0&quot;</span>);<br> <span class="hljs-number">47</span>                 &#125;<br> <span class="hljs-number">48</span>                 <span class="hljs-keyword">break</span>;<br> <span class="hljs-number">49</span>             &#125;<br> <span class="hljs-number">50</span>         &#125;<br> <span class="hljs-number">51</span> <span class="hljs-meta"># <span class="hljs-meta-keyword">endif</span></span><br> <span class="hljs-number">53</span> <span class="hljs-meta"># <span class="hljs-meta-keyword">if</span> TARGET_OS_OSX</span><br> <span class="hljs-number">54</span>         <span class="hljs-comment">// Disable non-pointer isa if the app is too old</span><br> <span class="hljs-number">55</span>         <span class="hljs-comment">// (linked before OS X 10.11)</span><br> <span class="hljs-number">56</span>         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">dyld_get_program_sdk_version</span>() &lt; DYLD_MACOSX_VERSION_10_11) &#123;<br> <span class="hljs-number">57</span>             DisableNonpointerIsa = <span class="hljs-literal">true</span>;<br> <span class="hljs-number">58</span>             <span class="hljs-keyword">if</span> (PrintRawIsa) &#123;<br> <span class="hljs-number">59</span>                 _objc_inform(<span class="hljs-string">&quot;RAW ISA: disabling non-pointer isa because &quot;</span><br> <span class="hljs-number">60</span>                              <span class="hljs-string">&quot;the app is too old (SDK version &quot;</span> SDK_FORMAT <span class="hljs-string">&quot;)&quot;</span>,<br> <span class="hljs-number">61</span>                              <span class="hljs-built_in">FORMAT_SDK</span>(<span class="hljs-built_in">dyld_get_program_sdk_version</span>()));<br> <span class="hljs-number">62</span>             &#125;<br> <span class="hljs-number">63</span>         &#125;<br> <span class="hljs-number">65</span>         <span class="hljs-comment">// Disable non-pointer isa if the app has a __DATA,__objc_rawisa section</span><br> <span class="hljs-number">66</span>         <span class="hljs-comment">// New apps that load old extensions may need this.</span><br> <span class="hljs-number">67</span>         <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br> <span class="hljs-number">68</span>             <span class="hljs-keyword">if</span> (hi-&gt;<span class="hljs-built_in">mhdr</span>()-&gt;filetype != MH_EXECUTE) <span class="hljs-keyword">continue</span>;<br> <span class="hljs-number">69</span>             <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> size;<br> <span class="hljs-number">70</span>             <span class="hljs-keyword">if</span> (<span class="hljs-built_in">getsectiondata</span>(hi-&gt;<span class="hljs-built_in">mhdr</span>(), <span class="hljs-string">&quot;__DATA&quot;</span>, <span class="hljs-string">&quot;__objc_rawisa&quot;</span>, &amp;size)) &#123;<br> <span class="hljs-number">71</span>                 DisableNonpointerIsa = <span class="hljs-literal">true</span>;<br> <span class="hljs-number">72</span>                 <span class="hljs-keyword">if</span> (PrintRawIsa) &#123;<br> <span class="hljs-number">73</span>                     _objc_inform(<span class="hljs-string">&quot;RAW ISA: disabling non-pointer isa because &quot;</span><br> <span class="hljs-number">74</span>                                  <span class="hljs-string">&quot;the app has a __DATA,__objc_rawisa section&quot;</span>);<br> <span class="hljs-number">75</span>                 &#125;<br> <span class="hljs-number">76</span>             &#125;<br> <span class="hljs-number">77</span>             <span class="hljs-keyword">break</span>;  <span class="hljs-comment">// assume only one MH_EXECUTE image</span><br> <span class="hljs-number">78</span>         &#125;<br> <span class="hljs-number">79</span> <span class="hljs-meta"># <span class="hljs-meta-keyword">endif</span></span><br> <span class="hljs-number">81</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br> <span class="hljs-number">83</span>         <span class="hljs-keyword">if</span> (DisableTaggedPointers) &#123;<br> <span class="hljs-number">84</span>             <span class="hljs-built_in">disableTaggedPointers</span>();<br> <span class="hljs-number">85</span>         &#125;<br> <span class="hljs-number">87</span>         <span class="hljs-built_in">initializeTaggedPointerObfuscator</span>();<br> <span class="hljs-number">89</span>         <span class="hljs-keyword">if</span> (PrintConnecting) &#123;<br> <span class="hljs-number">90</span>             _objc_inform(<span class="hljs-string">&quot;CLASS: found %d classes during launch&quot;</span>, totalClasses);<br> <span class="hljs-number">91</span>         &#125;<br> <span class="hljs-number">93</span>         <span class="hljs-comment">// namedClasses</span><br> <span class="hljs-number">94</span>         <span class="hljs-comment">// Preoptimized classes don&#x27;t go in this table.</span><br> <span class="hljs-number">95</span>         <span class="hljs-comment">// 4/3 is NXMapTable&#x27;s load factor</span><br> <span class="hljs-number">96</span>         <span class="hljs-keyword">int</span> namedClassesSize = <br> <span class="hljs-number">97</span>             (<span class="hljs-built_in">isPreoptimized</span>() ? unoptimizedTotalClasses : totalClasses) * <span class="hljs-number">4</span> / <span class="hljs-number">3</span>;<br> <span class="hljs-number">98</span>         gdb_objc_realized_classes =<br> <span class="hljs-number">99</span>             <span class="hljs-built_in">NXCreateMapTable</span>(NXStrValueMapPrototype, namedClassesSize);<br><span class="hljs-number">101</span>         ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: first time tasks&quot;</span>);<br><span class="hljs-number">102</span>     &#125;<br><span class="hljs-number">104</span>     <span class="hljs-comment">// Fix up @selector references</span><br><span class="hljs-number">105</span>     <span class="hljs-keyword">static</span> <span class="hljs-keyword">size_t</span> UnfixedSelectors;<br><span class="hljs-number">106</span>     &#123;<br><span class="hljs-number">107</span>         <span class="hljs-function"><span class="hljs-keyword">mutex_locker_t</span> <span class="hljs-title">lock</span><span class="hljs-params">(selLock)</span></span>;<br><span class="hljs-number">108</span>         <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br><span class="hljs-number">109</span>             <span class="hljs-keyword">if</span> (hi-&gt;<span class="hljs-built_in">hasPreoptimizedSelectors</span>()) <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">111</span>             <span class="hljs-keyword">bool</span> isBundle = hi-&gt;<span class="hljs-built_in">isBundle</span>();<br><span class="hljs-number">112</span>             SEL *sels = _getObjc2SelectorRefs(hi, &amp;count);<br><span class="hljs-number">113</span>             UnfixedSelectors += count;<br><span class="hljs-number">114</span>             <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-number">115</span>                 <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name = <span class="hljs-built_in">sel_cname</span>(sels[i]);<br><span class="hljs-number">116</span>                 SEL sel = <span class="hljs-built_in">sel_registerNameNoLock</span>(name, isBundle);<br><span class="hljs-number">117</span>                 <span class="hljs-keyword">if</span> (sels[i] != sel) &#123;<br><span class="hljs-number">118</span>                     sels[i] = sel;<br><span class="hljs-number">119</span>                 &#125;<br><span class="hljs-number">120</span>             &#125;<br><span class="hljs-number">121</span>         &#125;<br><span class="hljs-number">122</span>     &#125;<br><span class="hljs-number">124</span>     ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: fix up selector references&quot;</span>);<br><span class="hljs-number">126</span>     <span class="hljs-comment">// Discover classes. Fix up unresolved future classes. Mark bundle classes.</span><br><span class="hljs-number">127</span>     <span class="hljs-keyword">bool</span> hasDyldRoots = <span class="hljs-built_in">dyld_shared_cache_some_image_overridden</span>();<br><span class="hljs-number">129</span>     <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br><span class="hljs-number">130</span>         <span class="hljs-keyword">if</span> (! <span class="hljs-built_in">mustReadClasses</span>(hi, hasDyldRoots)) &#123;<br><span class="hljs-number">131</span>             <span class="hljs-comment">// Image is sufficiently optimized that we need not call readClass()</span><br><span class="hljs-number">132</span>             <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">133</span>         &#125;<br><span class="hljs-number">135</span>         <span class="hljs-keyword">classref_t</span> <span class="hljs-keyword">const</span> *classlist = _getObjc2ClassList(hi, &amp;count);<br><span class="hljs-number">137</span>         <span class="hljs-keyword">bool</span> headerIsBundle = hi-&gt;<span class="hljs-built_in">isBundle</span>();<br><span class="hljs-number">138</span>         <span class="hljs-keyword">bool</span> headerIsPreoptimized = hi-&gt;<span class="hljs-built_in">hasPreoptimizedClasses</span>();<br><span class="hljs-number">140</span>         <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-number">141</span>             Class cls = (Class)classlist[i];<br><span class="hljs-number">142</span>             Class newCls = <span class="hljs-built_in">readClass</span>(cls, headerIsBundle, headerIsPreoptimized);<br><span class="hljs-number">144</span>             <span class="hljs-keyword">if</span> (newCls != cls  &amp;&amp;  newCls) &#123;<br><span class="hljs-number">145</span>                 <span class="hljs-comment">// Class was moved but not deleted. Currently this occurs </span><br><span class="hljs-number">146</span>                 <span class="hljs-comment">// only when the new class resolved a future class.</span><br><span class="hljs-number">147</span>                 <span class="hljs-comment">// Non-lazily realize the class below.</span><br><span class="hljs-number">148</span>                 resolvedFutureClasses = (Class *)<br><span class="hljs-number">149</span>                     <span class="hljs-built_in">realloc</span>(resolvedFutureClasses, <br><span class="hljs-number">150</span>                             (resolvedFutureClassCount+<span class="hljs-number">1</span>) * <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(Class));<br><span class="hljs-number">151</span>                 resolvedFutureClasses[resolvedFutureClassCount++] = newCls;<br><span class="hljs-number">152</span>             &#125;<br><span class="hljs-number">153</span>         &#125;<br><span class="hljs-number">154</span>     &#125;<br><span class="hljs-number">156</span>     ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: discover classes&quot;</span>);<br><span class="hljs-number">158</span>     <span class="hljs-comment">// Fix up remapped classes</span><br><span class="hljs-number">159</span>     <span class="hljs-comment">// Class list and nonlazy class list remain unremapped.</span><br><span class="hljs-number">160</span>     <span class="hljs-comment">// Class refs and super refs are remapped for message dispatching.</span><br><span class="hljs-number">162</span>     <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">noClassesRemapped</span>()) &#123;<br><span class="hljs-number">163</span>         <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br><span class="hljs-number">164</span>             Class *classrefs = _getObjc2ClassRefs(hi, &amp;count);<br><span class="hljs-number">165</span>             <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-number">166</span>                 <span class="hljs-built_in">remapClassRef</span>(&amp;classrefs[i]);<br><span class="hljs-number">167</span>             &#125;<br><span class="hljs-number">168</span>             <span class="hljs-comment">// fixme why doesn&#x27;t test future1 catch the absence of this?</span><br><span class="hljs-number">169</span>             classrefs = _getObjc2SuperRefs(hi, &amp;count);<br><span class="hljs-number">170</span>             <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-number">171</span>                 <span class="hljs-built_in">remapClassRef</span>(&amp;classrefs[i]);<br><span class="hljs-number">172</span>             &#125;<br><span class="hljs-number">173</span>         &#125;<br><span class="hljs-number">174</span>     &#125;<br><span class="hljs-number">176</span>     ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: remap classes&quot;</span>);<br><span class="hljs-number">178</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> SUPPORT_FIXUP</span><br><span class="hljs-number">179</span>     <span class="hljs-comment">// Fix up old objc_msgSend_fixup call sites</span><br><span class="hljs-number">180</span>     <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br><span class="hljs-number">181</span>         <span class="hljs-keyword">message_ref_t</span> *refs = _getObjc2MessageRefs(hi, &amp;count);<br><span class="hljs-number">182</span>         <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">184</span>         <span class="hljs-keyword">if</span> (PrintVtables) &#123;<br><span class="hljs-number">185</span>             _objc_inform(<span class="hljs-string">&quot;VTABLES: repairing %zu unsupported vtable dispatch &quot;</span><br><span class="hljs-number">186</span>                          <span class="hljs-string">&quot;call sites in %s&quot;</span>, count, hi-&gt;<span class="hljs-built_in">fname</span>());<br><span class="hljs-number">187</span>         &#125;<br><span class="hljs-number">188</span>         <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-number">189</span>             <span class="hljs-built_in">fixupMessageRef</span>(refs+i);<br><span class="hljs-number">190</span>         &#125;<br><span class="hljs-number">191</span>     &#125;<br><span class="hljs-number">193</span>     ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: fix up objc_msgSend_fixup&quot;</span>);<br><span class="hljs-number">194</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-number">196</span>     <span class="hljs-keyword">bool</span> cacheSupportsProtocolRoots = <span class="hljs-built_in">sharedCacheSupportsProtocolRoots</span>();<br><span class="hljs-number">198</span>     <span class="hljs-comment">// Discover protocols. Fix up protocol refs.</span><br><span class="hljs-number">199</span>     <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br><span class="hljs-number">200</span>         <span class="hljs-keyword">extern</span> objc_class OBJC_CLASS_$_Protocol;<br><span class="hljs-number">201</span>         Class cls = (Class)&amp;OBJC_CLASS_$_Protocol;<br><span class="hljs-number">202</span>         <span class="hljs-built_in">ASSERT</span>(cls);<br><span class="hljs-number">203</span>         NXMapTable *protocol_map = <span class="hljs-built_in">protocols</span>();<br><span class="hljs-number">204</span>         <span class="hljs-keyword">bool</span> isPreoptimized = hi-&gt;<span class="hljs-built_in">hasPreoptimizedProtocols</span>();<br><span class="hljs-number">206</span>         <span class="hljs-comment">// Skip reading protocols if this is an image from the shared cache</span><br><span class="hljs-number">207</span>         <span class="hljs-comment">// and we support roots</span><br><span class="hljs-number">208</span>         <span class="hljs-comment">// Note, after launch we do need to walk the protocol as the protocol</span><br><span class="hljs-number">209</span>         <span class="hljs-comment">// in the shared cache is marked with isCanonical() and that may not</span><br><span class="hljs-number">210</span>         <span class="hljs-comment">// be true if some non-shared cache binary was chosen as the canonical</span><br><span class="hljs-number">211</span>         <span class="hljs-comment">// definition</span><br><span class="hljs-number">212</span>         <span class="hljs-keyword">if</span> (launchTime &amp;&amp; isPreoptimized &amp;&amp; cacheSupportsProtocolRoots) &#123;<br><span class="hljs-number">213</span>             <span class="hljs-keyword">if</span> (PrintProtocols) &#123;<br><span class="hljs-number">214</span>                 _objc_inform(<span class="hljs-string">&quot;PROTOCOLS: Skipping reading protocols in image: %s&quot;</span>,<br><span class="hljs-number">215</span>                              hi-&gt;<span class="hljs-built_in">fname</span>());<br><span class="hljs-number">216</span>             &#125;<br><span class="hljs-number">217</span>             <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">218</span>         &#125;<br><span class="hljs-number">220</span>         <span class="hljs-keyword">bool</span> isBundle = hi-&gt;<span class="hljs-built_in">isBundle</span>();<br><span class="hljs-number">222</span>         <span class="hljs-keyword">protocol_t</span> * <span class="hljs-keyword">const</span> *protolist = _getObjc2ProtocolList(hi, &amp;count);<br><span class="hljs-number">223</span>         <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-number">224</span>             <span class="hljs-built_in">readProtocol</span>(protolist[i], cls, protocol_map, <br><span class="hljs-number">225</span>                          isPreoptimized, isBundle);<br><span class="hljs-number">226</span>         &#125;<br><span class="hljs-number">227</span>     &#125;<br><span class="hljs-number">229</span>     ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: discover protocols&quot;</span>);<br><span class="hljs-number">231</span>     <span class="hljs-comment">// Fix up @protocol references</span><br><span class="hljs-number">232</span>     <span class="hljs-comment">// Preoptimized images may have the right </span><br><span class="hljs-number">233</span>     <span class="hljs-comment">// answer already but we don&#x27;t know for sure.</span><br><span class="hljs-number">234</span>     <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br><span class="hljs-number">235</span>         <span class="hljs-comment">// At launch time, we know preoptimized image refs are pointing at the</span><br><span class="hljs-number">236</span>         <span class="hljs-comment">// shared cache definition of a protocol.  We can skip the check on</span><br><span class="hljs-number">237</span>         <span class="hljs-comment">// launch, but have to visit @protocol refs for shared cache images</span><br><span class="hljs-number">238</span>         <span class="hljs-comment">// loaded later.</span><br><span class="hljs-number">239</span>         <span class="hljs-keyword">if</span> (launchTime &amp;&amp; cacheSupportsProtocolRoots &amp;&amp; hi-&gt;<span class="hljs-built_in">isPreoptimized</span>())<br><span class="hljs-number">240</span>             <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">241</span>         <span class="hljs-keyword">protocol_t</span> **protolist = _getObjc2ProtocolRefs(hi, &amp;count);<br><span class="hljs-number">242</span>         <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-number">243</span>             <span class="hljs-built_in">remapProtocolRef</span>(&amp;protolist[i]);<br><span class="hljs-number">244</span>         &#125;<br><span class="hljs-number">245</span>     &#125;<br><span class="hljs-number">247</span>     ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: fix up @protocol references&quot;</span>);<br><span class="hljs-number">249</span>     <span class="hljs-comment">// Discover categories. Only do this after the initial category</span><br><span class="hljs-number">250</span>     <span class="hljs-comment">// attachment has been done. For categories present at startup,</span><br><span class="hljs-number">251</span>     <span class="hljs-comment">// discovery is deferred until the first load_images call after</span><br><span class="hljs-number">252</span>     <span class="hljs-comment">// the call to _dyld_objc_notify_register completes. rdar://problem/53119145</span><br><span class="hljs-number">253</span>     <span class="hljs-keyword">if</span> (didInitialAttachCategories) &#123;<br><span class="hljs-number">254</span>         <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br><span class="hljs-number">255</span>             <span class="hljs-built_in">load_categories_nolock</span>(hi);<br><span class="hljs-number">256</span>         &#125;<br><span class="hljs-number">257</span>     &#125;<br><span class="hljs-number">259</span>     ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: discover categories&quot;</span>);<br><span class="hljs-number">261</span>     <span class="hljs-comment">// Category discovery MUST BE Late to avoid potential races</span><br><span class="hljs-number">262</span>     <span class="hljs-comment">// when other threads call the new category code before</span><br><span class="hljs-number">263</span>     <span class="hljs-comment">// this thread finishes its fixups.</span><br><span class="hljs-number">265</span>     <span class="hljs-comment">// +load handled by prepare_load_methods()</span><br><span class="hljs-number">267</span>     <span class="hljs-comment">// Realize non-lazy classes (for +load methods and static instances)</span><br><span class="hljs-number">268</span>     <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br><span class="hljs-number">269</span>         <span class="hljs-keyword">classref_t</span> <span class="hljs-keyword">const</span> *classlist = <br><span class="hljs-number">270</span>             _getObjc2NonlazyClassList(hi, &amp;count);<br><span class="hljs-number">271</span>         <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-number">272</span>             Class cls = <span class="hljs-built_in">remapClass</span>(classlist[i]);<br><span class="hljs-number">273</span>             <span class="hljs-keyword">if</span> (!cls) <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">275</span>             <span class="hljs-built_in">addClassTableEntry</span>(cls);<br><span class="hljs-number">277</span>             <span class="hljs-keyword">if</span> (cls-&gt;<span class="hljs-built_in">isSwiftStable</span>()) &#123;<br><span class="hljs-number">278</span>                 <span class="hljs-keyword">if</span> (cls-&gt;<span class="hljs-built_in">swiftMetadataInitializer</span>()) &#123;<br><span class="hljs-number">279</span>                     _objc_fatal(<span class="hljs-string">&quot;Swift class %s with a metadata initializer &quot;</span><br><span class="hljs-number">280</span>                                 <span class="hljs-string">&quot;is not allowed to be non-lazy&quot;</span>,<br><span class="hljs-number">281</span>                                 cls-&gt;<span class="hljs-built_in">nameForLogging</span>());<br><span class="hljs-number">282</span>                 &#125;<br><span class="hljs-number">283</span>                 <span class="hljs-comment">// fixme also disallow relocatable classes</span><br><span class="hljs-number">284</span>                 <span class="hljs-comment">// We can&#x27;t disallow all Swift classes because of</span><br><span class="hljs-number">285</span>                 <span class="hljs-comment">// classes like Swift.__EmptyArrayStorage</span><br><span class="hljs-number">286</span>             &#125;<br><span class="hljs-number">287</span>             <span class="hljs-built_in">realizeClassWithoutSwift</span>(cls, nil);<br><span class="hljs-number">288</span>         &#125;<br><span class="hljs-number">289</span>     &#125;<br><span class="hljs-number">291</span>     ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: realize non-lazy classes&quot;</span>);<br><span class="hljs-number">293</span>     <span class="hljs-comment">// Realize newly-resolved future classes, in case CF manipulates them</span><br><span class="hljs-number">294</span>     <span class="hljs-keyword">if</span> (resolvedFutureClasses) &#123;<br><span class="hljs-number">295</span>         <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; resolvedFutureClassCount; i++) &#123;<br><span class="hljs-number">296</span>             Class cls = resolvedFutureClasses[i];<br><span class="hljs-number">297</span>             <span class="hljs-keyword">if</span> (cls-&gt;<span class="hljs-built_in">isSwiftStable</span>()) &#123;<br><span class="hljs-number">298</span>                 _objc_fatal(<span class="hljs-string">&quot;Swift class is not allowed to be future&quot;</span>);<br><span class="hljs-number">299</span>             &#125;<br><span class="hljs-number">300</span>             <span class="hljs-built_in">realizeClassWithoutSwift</span>(cls, nil);<br><span class="hljs-number">301</span>             cls-&gt;<span class="hljs-built_in">setInstancesRequireRawIsaRecursively</span>(<span class="hljs-literal">false</span><span class="hljs-comment">/*inherited*/</span>);<br><span class="hljs-number">302</span>         &#125;<br><span class="hljs-number">303</span>         <span class="hljs-built_in">free</span>(resolvedFutureClasses);<br><span class="hljs-number">304</span>     &#125;<br><span class="hljs-number">306</span>     ts.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;IMAGE TIMES: realize future classes&quot;</span>);<br><span class="hljs-number">308</span>     <span class="hljs-keyword">if</span> (DebugNonFragileIvars) &#123;<br><span class="hljs-number">309</span>         <span class="hljs-built_in">realizeAllClasses</span>();<br><span class="hljs-number">310</span>     &#125;<br><span class="hljs-number">313</span>     <span class="hljs-comment">// Print preoptimization statistics</span><br><span class="hljs-number">314</span>     <span class="hljs-keyword">if</span> (PrintPreopt) &#123;<br><span class="hljs-number">315</span>         <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> PreoptTotalMethodLists;<br><span class="hljs-number">316</span>         <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> PreoptOptimizedMethodLists;<br><span class="hljs-number">317</span>         <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> PreoptTotalClasses;<br><span class="hljs-number">318</span>         <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> PreoptOptimizedClasses;<br><span class="hljs-number">320</span>         <span class="hljs-keyword">for</span> (EACH_HEADER) &#123;<br><span class="hljs-number">321</span>             <span class="hljs-keyword">if</span> (hi-&gt;<span class="hljs-built_in">hasPreoptimizedSelectors</span>()) &#123;<br><span class="hljs-number">322</span>                 _objc_inform(<span class="hljs-string">&quot;PREOPTIMIZATION: honoring preoptimized selectors &quot;</span><br><span class="hljs-number">323</span>                              <span class="hljs-string">&quot;in %s&quot;</span>, hi-&gt;<span class="hljs-built_in">fname</span>());<br><span class="hljs-number">324</span>             &#125;<br><span class="hljs-number">325</span>             <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hi-&gt;<span class="hljs-built_in">info</span>()-&gt;<span class="hljs-built_in">optimizedByDyld</span>()) &#123;<br><span class="hljs-number">326</span>                 _objc_inform(<span class="hljs-string">&quot;PREOPTIMIZATION: IGNORING preoptimized selectors &quot;</span><br><span class="hljs-number">327</span>                              <span class="hljs-string">&quot;in %s&quot;</span>, hi-&gt;<span class="hljs-built_in">fname</span>());<br><span class="hljs-number">328</span>             &#125;<br><span class="hljs-number">330</span>             <span class="hljs-keyword">classref_t</span> <span class="hljs-keyword">const</span> *classlist = _getObjc2ClassList(hi, &amp;count);<br><span class="hljs-number">331</span>             <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br><span class="hljs-number">332</span>                 Class cls = <span class="hljs-built_in">remapClass</span>(classlist[i]);<br><span class="hljs-number">333</span>                 <span class="hljs-keyword">if</span> (!cls) <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">335</span>                 PreoptTotalClasses++;<br><span class="hljs-number">336</span>                 <span class="hljs-keyword">if</span> (hi-&gt;<span class="hljs-built_in">hasPreoptimizedClasses</span>()) &#123;<br><span class="hljs-number">337</span>                     PreoptOptimizedClasses++;<br><span class="hljs-number">338</span>                 &#125;<br><span class="hljs-number">340</span>                 <span class="hljs-keyword">const</span> <span class="hljs-keyword">method_list_t</span> *mlist;<br><span class="hljs-number">341</span>                 <span class="hljs-keyword">if</span> ((mlist = ((<span class="hljs-keyword">class_ro_t</span> *)cls-&gt;<span class="hljs-built_in">data</span>())-&gt;<span class="hljs-built_in">baseMethods</span>())) &#123;<br><span class="hljs-number">342</span>                     PreoptTotalMethodLists++;<br><span class="hljs-number">343</span>                     <span class="hljs-keyword">if</span> (mlist-&gt;<span class="hljs-built_in">isFixedUp</span>()) &#123;<br><span class="hljs-number">344</span>                         PreoptOptimizedMethodLists++;<br><span class="hljs-number">345</span>                     &#125;<br><span class="hljs-number">346</span>                 &#125;<br><span class="hljs-number">347</span>                 <span class="hljs-keyword">if</span> ((mlist=((<span class="hljs-keyword">class_ro_t</span> *)cls-&gt;<span class="hljs-built_in">ISA</span>()-&gt;<span class="hljs-built_in">data</span>())-&gt;<span class="hljs-built_in">baseMethods</span>())) &#123;<br><span class="hljs-number">348</span>                     PreoptTotalMethodLists++;<br><span class="hljs-number">349</span>                     <span class="hljs-keyword">if</span> (mlist-&gt;<span class="hljs-built_in">isFixedUp</span>()) &#123;<br><span class="hljs-number">350</span>                         PreoptOptimizedMethodLists++;<br><span class="hljs-number">351</span>                     &#125;<br><span class="hljs-number">352</span>                 &#125;<br><span class="hljs-number">353</span>             &#125;<br><span class="hljs-number">354</span>         &#125;<br><span class="hljs-number">356</span>         _objc_inform(<span class="hljs-string">&quot;PREOPTIMIZATION: %zu selector references not &quot;</span><br><span class="hljs-number">357</span>                      <span class="hljs-string">&quot;pre-optimized&quot;</span>, UnfixedSelectors);<br><span class="hljs-number">358</span>         _objc_inform(<span class="hljs-string">&quot;PREOPTIMIZATION: %u/%u (%.3g%%) method lists pre-sorted&quot;</span>,<br><span class="hljs-number">359</span>                      PreoptOptimizedMethodLists, PreoptTotalMethodLists, <br><span class="hljs-number">360</span>                      PreoptTotalMethodLists<br><span class="hljs-number">361</span>                      ? <span class="hljs-number">100.0</span>*PreoptOptimizedMethodLists/PreoptTotalMethodLists <br><span class="hljs-number">362</span>                      : <span class="hljs-number">0.0</span>);<br><span class="hljs-number">363</span>         _objc_inform(<span class="hljs-string">&quot;PREOPTIMIZATION: %u/%u (%.3g%%) classes pre-registered&quot;</span>,<br><span class="hljs-number">364</span>                      PreoptOptimizedClasses, PreoptTotalClasses, <br><span class="hljs-number">365</span>                      PreoptTotalClasses <br><span class="hljs-number">366</span>                      ? <span class="hljs-number">100.0</span>*PreoptOptimizedClasses/PreoptTotalClasses<br><span class="hljs-number">367</span>                      : <span class="hljs-number">0.0</span>);<br><span class="hljs-number">368</span>         _objc_inform(<span class="hljs-string">&quot;PREOPTIMIZATION: %zu protocol references not &quot;</span><br><span class="hljs-number">369</span>                      <span class="hljs-string">&quot;pre-optimized&quot;</span>, UnfixedProtocolReferences);<br><span class="hljs-number">370</span>     &#125;<br><span class="hljs-number">372</span> <span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> EACH_HEADER</span><br><span class="hljs-number">373</span> &#125;<br></code></pre></td></tr></table></figure>



<p>read_images 做了什么，概括：</p>
<ol>
<li> 条件控制进行一次性的加载 - once</li>
<li> 修复预编译阶段的 ‘@selector’ 的混乱问题</li>
<li> 错误混乱的 类 的处理</li>
<li> 修复 重映射 一些没有被镜像文件加载进来的类</li>
<li> 修复一些消息</li>
<li> 当类里面有协议时，readProtocol</li>
<li> 修复没被加载的协议</li>
<li> 分类的处理</li>
<li> 非懒加载的类的加载处理</li>
<li> 实现新解析的未来类，以防 CF 操作它们</li>
</ol>
<p><strong>下面对 read_images 详细解析</strong>：</p>
<h4 id="1、fix-up-selector-上面源码的-104-行-："><a href="#1、fix-up-selector-上面源码的-104-行-：" class="headerlink" title="1、fix up @selector(上面源码的 104 行)："></a>1、fix up @selector(上面源码的 104 行)：</h4><p>selector 并非简单的字符串，而是一串 带地址的字符串.</p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018155256340-616621741.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2、Discover-classes-类的处理-上面代码的-126-行开始"><a href="#2、Discover-classes-类的处理-上面代码的-126-行开始" class="headerlink" title="2、Discover classes 类的处理 (上面代码的 126 行开始)"></a>2、Discover classes 类的处理 (上面代码的 126 行开始)</h4><p>144 行：Class was moved but not deleted - 出现类的混乱的场景比较少，代码暂时执行不进去。</p>
<p>对于类，一般加载内存后不会移动，相对移动来说更倾向于删除重建，移动对性能能消耗太大。</p>
<p>142 行代码 readClass():</p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018161340532-1161517106.png" srcset="/img/loading.gif" lazyload></p>
<p>readClass() 做了什么？.</p>
<p><strong>readClass()</strong> 的实现源码：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-number">1</span> <span class="hljs-comment">/***********************************************************************</span><br><span class="hljs-comment"> 2 * readClass</span><br><span class="hljs-comment"> 3 * Read a class and metaclass as written by a compiler.</span><br><span class="hljs-comment"> 4 * Returns the new class pointer. This could be: </span><br><span class="hljs-comment"> 5 * - cls</span><br><span class="hljs-comment"> 6 * - nil  (cls has a missing weak-linked superclass)</span><br><span class="hljs-comment"> 7 * - something else (space for this class was reserved by a future class)</span><br><span class="hljs-comment"> 8 *</span><br><span class="hljs-comment"> 9 * Note that all work performed by this function is preflighted by </span><br><span class="hljs-comment">10 * mustReadClasses(). Do not change this function without updating that one.</span><br><span class="hljs-comment">11 *</span><br><span class="hljs-comment">12 * Locking: runtimeLock acquired by map_images or objc_readClassPair</span><br><span class="hljs-comment">13 **********************************************************************/</span><br><span class="hljs-number">14</span> Class readClass(Class cls, bool headerIsBundle, bool headerIsPreoptimized)<br><span class="hljs-number">15</span> &#123;<br><span class="hljs-number">16</span>     <span class="hljs-function"><span class="hljs-title">const</span> char *mangledName = cls-&gt;</span>mangledName();<br><span class="hljs-number">18</span>     <span class="hljs-keyword">if</span> (missingWeakSuperclass(cls)) &#123;<br><span class="hljs-number">19</span>         <span class="hljs-comment">// No superclass (probably weak-linked). </span><br><span class="hljs-number">20</span>         <span class="hljs-comment">// Disavow any knowledge of this subclass.</span><br><span class="hljs-number">21</span>         <span class="hljs-keyword">if</span> (PrintConnecting) &#123;<br><span class="hljs-number">22</span>             _objc_inform(<span class="hljs-string">&quot;CLASS: IGNORING class &#x27;%s&#x27; with &quot;</span><br><span class="hljs-number">23</span>                          <span class="hljs-string">&quot;missing weak-linked superclass&quot;</span>, <br><span class="hljs-number">24</span>                          <span class="hljs-function"><span class="hljs-title">cls</span>-&gt;</span>nameForLogging());<br><span class="hljs-number">25</span>         &#125;<br><span class="hljs-number">26</span>         addRemappedClass(cls, <span class="hljs-literal">nil</span>);<br><span class="hljs-number">27</span>         <span class="hljs-function"><span class="hljs-title">cls</span>-&gt;</span>superclass = <span class="hljs-literal">nil</span>;<br><span class="hljs-number">28</span>         return <span class="hljs-literal">nil</span>;<br><span class="hljs-number">29</span>     &#125;<br><span class="hljs-number">31</span>     <span class="hljs-function"><span class="hljs-title">cls</span>-&gt;</span>fixupBackwardDeployingStableSwift();<br><span class="hljs-number">33</span>     Class replacing = <span class="hljs-literal">nil</span>;<br><span class="hljs-number">34</span>     <span class="hljs-keyword">if</span> (Class newCls = popFutureNamedClass(mangledName)) &#123;<br><span class="hljs-number">35</span>         <span class="hljs-comment">// This name was previously allocated as a future class.</span><br><span class="hljs-number">36</span>         <span class="hljs-comment">// Copy objc_class to future class&#x27;s struct.</span><br><span class="hljs-number">37</span>         <span class="hljs-comment">// Preserve future&#x27;s rw data block.</span><br><span class="hljs-number">39</span>         <span class="hljs-function"><span class="hljs-title">if</span> (newCls-&gt;</span>isAnySwift()) &#123;<br><span class="hljs-number">40</span>             _objc_fatal(<span class="hljs-string">&quot;Can&#x27;t complete future class request for &#x27;%s&#x27; &quot;</span><br><span class="hljs-number">41</span>                         <span class="hljs-string">&quot;because the real class is too big.&quot;</span>, <br><span class="hljs-number">42</span>                         <span class="hljs-function"><span class="hljs-title">cls</span>-&gt;</span>nameForLogging());<br><span class="hljs-number">43</span>         &#125;<br><span class="hljs-number">45</span>         <span class="hljs-function"><span class="hljs-title">class_rw_t</span> *rw = newCls-&gt;</span><span class="hljs-keyword">data</span>();<br><span class="hljs-number">46</span>         <span class="hljs-function"><span class="hljs-title">const</span> class_ro_t *old_ro = rw-&gt;</span>ro();<br><span class="hljs-number">47</span>         memcpy(newCls, cls, sizeof(objc_class));<br><span class="hljs-number">48</span>         <span class="hljs-function"><span class="hljs-title">rw</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">set_ro</span>((class_ro_t *)newCls-&gt;</span><span class="hljs-keyword">data</span>());<br><span class="hljs-number">49</span>         <span class="hljs-function"><span class="hljs-title">newCls</span>-&gt;</span>setData(rw);<br><span class="hljs-number">50</span>         <span class="hljs-function"><span class="hljs-title">freeIfMutable</span>((char *)old_ro-&gt;</span><span class="hljs-keyword">name</span>);<br><span class="hljs-number">51</span>         free((void *)old_ro);<br><span class="hljs-number">53</span>         addRemappedClass(cls, newCls);<br><span class="hljs-number">55</span>         replacing = cls;<br><span class="hljs-number">56</span>         cls = newCls;<br><span class="hljs-number">57</span>     &#125;<br><span class="hljs-number">59</span>     <span class="hljs-keyword">if</span> (headerIsPreoptimized  &amp;&amp;  !replacing) &#123;<br><span class="hljs-number">60</span>         <span class="hljs-comment">// class list built in shared cache</span><br><span class="hljs-number">61</span>         <span class="hljs-comment">// fixme strict assert doesn&#x27;t work because of duplicates</span><br><span class="hljs-number">62</span>         <span class="hljs-comment">// ASSERT(cls == getClass(name));</span><br><span class="hljs-number">63</span>         ASSERT(getClassExceptSomeSwift(mangledName));<br><span class="hljs-number">64</span>     &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-number">65</span>         addNamedClass(cls, mangledName, replacing);<br><span class="hljs-number">66</span>         addClassTableEntry(cls);<br><span class="hljs-number">67</span>     &#125;<br><span class="hljs-number">69</span>     <span class="hljs-comment">// for future reference: shared cache never contains MH_BUNDLEs</span><br><span class="hljs-number">70</span>     <span class="hljs-keyword">if</span> (headerIsBundle) &#123;<br><span class="hljs-number">71</span>         <span class="hljs-function"><span class="hljs-title">cls</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">data</span>()-&gt;</span>flags |= RO_FROM_BUNDLE;<br><span class="hljs-number">72</span>         <span class="hljs-function"><span class="hljs-title">cls</span>-&gt;</span>ISA()-&gt;<span class="hljs-function"><span class="hljs-title">data</span>()-&gt;</span>flags |= RO_FROM_BUNDLE;<br><span class="hljs-number">73</span>     &#125;<br><span class="hljs-number">75</span>     return cls;<br><span class="hljs-number">76</span> &#125;<br></code></pre></td></tr></table></figure>



<p>这里因系统类较多，不好调试，我们添加自己的类进行探究:</p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018164041713-480698231.png" srcset="/img/loading.gif" lazyload> </p>
<p> 继续断点调试：上面代码 34 行的并未进去！</p>
<p>走进了 65 行，即下图 3247 行：</p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018164837388-1017352855.png" srcset="/img/loading.gif" lazyload></p>
<p>**2.1）addNamedClass()**：–&gt; name 加到 cls 里面</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-number">1</span> <span class="hljs-comment">/***********************************************************************</span><br><span class="hljs-comment"> 2 * addNamedClass</span><br><span class="hljs-comment"> 3 * Adds name =&gt; cls to the named non-meta class map.// 将 name=&gt;cls 添加到费元类的映射</span><br><span class="hljs-comment"> 4 * Warns about duplicate class names and keeps the old mapping.// 重复的类名将保留旧的映射</span><br><span class="hljs-comment"> 5 * Locking: runtimeLock must be held by the caller</span><br><span class="hljs-comment"> 6 **********************************************************************/</span><br> <span class="hljs-number">7</span> static void add<span class="hljs-constructor">NamedClass(Class <span class="hljs-params">cls</span>, <span class="hljs-params">const</span> <span class="hljs-params">char</span> <span class="hljs-operator">*</span><span class="hljs-params">name</span>, Class <span class="hljs-params">replacing</span> = <span class="hljs-params">nil</span>)</span><br> <span class="hljs-number">8</span> &#123;<br> <span class="hljs-number">9</span>     runtimeLock.<span class="hljs-keyword">assert</span><span class="hljs-constructor">Locked()</span>;<br><span class="hljs-number">10</span>     Class old;<br><span class="hljs-number">11</span>     <span class="hljs-keyword">if</span> ((old = get<span class="hljs-constructor">ClassExceptSomeSwift(<span class="hljs-params">name</span>)</span>)<span class="hljs-operator">  &amp;&amp;  </span>old != replacing) &#123;<br><span class="hljs-number">12</span>         inform<span class="hljs-constructor">_duplicate(<span class="hljs-params">name</span>, <span class="hljs-params">old</span>, <span class="hljs-params">cls</span>)</span>;<br><span class="hljs-number">14</span>         <span class="hljs-comment">// getMaybeUnrealizedNonMetaClass uses name lookups.</span><br><span class="hljs-number">15</span>         <span class="hljs-comment">// Classes not found by name lookup must be in the</span><br><span class="hljs-number">16</span>         <span class="hljs-comment">// secondary meta-&gt;nonmeta table.</span><br><span class="hljs-number">17</span>         add<span class="hljs-constructor">NonMetaClass(<span class="hljs-params">cls</span>)</span>;<br><span class="hljs-number">18</span>     &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-number">19</span>         <span class="hljs-constructor">NXMapInsert(<span class="hljs-params">gdb_objc_realized_classes</span>, <span class="hljs-params">name</span>, <span class="hljs-params">cls</span>)</span>;<span class="hljs-comment">// 插入</span><br><span class="hljs-number">20</span>     &#125;<br><span class="hljs-number">21</span>     <span class="hljs-constructor">ASSERT(!(<span class="hljs-params">cls</span>-&gt;<span class="hljs-params">data</span>()</span>-&gt;flags &amp; RO_META));<br><span class="hljs-number">23</span>     <span class="hljs-comment">// wrong: constructed classes are already realized when they get here</span><br><span class="hljs-number">24</span>     <span class="hljs-comment">// ASSERT(!cls-&gt;isRealized());</span><br><span class="hljs-number">25</span> &#125;<br></code></pre></td></tr></table></figure>



<p>类名来自于 mangleName：–&gt; 已经初始化 or 未来类则从 ro 里面读，否则从 macho 的 data 里面读：</p>
<p><img src="https://img2020.cnblogs.com/blog/842658/202010/842658-20201018170052986-525652926.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>2.2）addClassTableEntry(cls)</strong> </p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">1 /<span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 2 *</span> addClassTableEntry</span><br><span class="hljs-strong"> 3 <span class="hljs-emphasis">* Add a class to the table of all classes. If addMeta is true,</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 4 *</span> automatically adds the metaclass of the class as well.</span><br><span class="hljs-strong"> 5 <span class="hljs-emphasis">* Locking: runtimeLock must be held by the caller.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> 6 <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**/</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"> 7 static void</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"> 8 addClassTableEntry(Class cls, bool addMeta = true)</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"> 9 &#123;</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">10     runtimeLock.assertLocked();</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">12     // This class is allowed to be a known class via the shared cache or via</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">13     // data segments, but it is not allowed to be in the dynamic table already.</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">14     auto &amp;set = objc::allocatedClasses.get();// 初始化位置在 runtime<span class="hljs-emphasis">_init()</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">16     ASSERT(set.find(cls) == set.end());</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">18     if (!isKnownClass(cls))</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">19         set.insert(cls);// 添加 insert</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">20     if (addMeta)</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">21         addClassTableEntry(cls-&gt;ISA(), false);// 元类就添加到元类</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">22 &#125;</span></span></span></span><br></code></pre></td></tr></table></figure>



<p><strong>readClass 做了：将 cls 从 macho 的格式里面 读取添加到内存里面</strong>。</p>
<p>篇幅较长，接下篇：<a href="">OC 底层探索 14、类的加载 2</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/OC%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2/">OC底层探索</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/OC/">OC</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%BA%95%E5%B1%82/">底层</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/10/23/2018-3/OC%20%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2%2014%E3%80%81%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%202%20-%20%E7%B1%BB%E7%9A%84%20data_%20/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">类的加载 2 - 类的 data_</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/10/12/2018-3/OC%20%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2%2012%E3%80%81%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%8A%A0%E8%BD%BD/">
                        <span class="hidden-mobile">应用程序加载</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
