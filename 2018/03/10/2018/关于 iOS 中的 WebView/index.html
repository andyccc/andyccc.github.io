

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="andyccc">
  <meta name="keywords" content="">
  
  <title>关于 iOS 中的 WebView - Hello</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="关于 iOS 中的 WebView">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2018-03-10 11:14" pubdate>
        2018年3月10日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      76
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">关于 iOS 中的 WebView</h1>
            
            <div class="markdown-body">
              <blockquote>
<p>UIWebView 使用方式与普通 View 一样。</p>
</blockquote>
<p>使用方式与普通 View 一样。内置一个 UIScrollView。</p>
<p>需要设置 UIWebViewDelegate。delegate 只有四个回调方法：是否开始，load 开始，load 完成，load 失败。</p>
<h2 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a><a href="#HTML" title="HTML"></a>HTML</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">[webView loadHTMLString:@&quot;<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>this is baidu!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>&quot; baseURL:];<br></code></pre></td></tr></table></figure>

<h2 id="HTML-File"><a href="#HTML-File" class="headerlink" title="HTML File"></a><a href="#HTML-File" title="HTML File"></a>HTML File</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSString</span> *str = [[<span class="hljs-built_in">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string">@&quot;index&quot;</span> ofType:<span class="hljs-string">@&quot;html&quot;</span>];<br><span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> fileURLWithPath:str];<br>[webView loadFileURL:url allowingReadAccessToURL:url];<br></code></pre></td></tr></table></figure>

<h2 id="NSData"><a href="#NSData" class="headerlink" title="NSData"></a><a href="#NSData" title="NSData"></a>NSData</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSString</span> *path = [[<span class="hljs-built_in">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string">@&quot;demo&quot;</span> ofType:<span class="hljs-string">@&quot;gif&quot;</span>];<br><span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfFile:path];<br>[webView loadData:data MIMEType:<span class="hljs-string">@&quot;image/gif&quot;</span> textEncodingName:<span class="hljs-string">@&quot;UTF-8&quot;</span> baseURL:url];<br>webView.userInteractionEnabled = <span class="hljs-literal">NO</span>;<br></code></pre></td></tr></table></figure>

<p>设置 MIMEType 为指定类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@<span class="hljs-string">&quot;image/jpg&quot;</span></span><br><span class="hljs-meta">@<span class="hljs-string">&quot;image/gif&quot;</span></span><br><span class="hljs-meta">@<span class="hljs-string">&quot;application/pdf&quot;</span></span><br></code></pre></td></tr></table></figure>

<h2 id="URLRequest"><a href="#URLRequest" class="headerlink" title="URLRequest"></a><a href="#URLRequest" title="URLRequest"></a>URLRequest</h2><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs inform7">NSURLRequest *request = <span class="hljs-comment">[NSURLRequest requestWithURL:<span class="hljs-comment">[NSURL URLWithString:urlString]</span>]</span>;<br><span class="hljs-comment">[webView loadRequest:request]</span>;<br></code></pre></td></tr></table></figure>

<h2 id="UIWebViewDelegate"><a href="#UIWebViewDelegate" class="headerlink" title="UIWebViewDelegate"></a><a href="#UIWebViewDelegate" title="UIWebViewDelegate"></a>UIWebViewDelegate</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// 是否运行load</span><br>- (<span class="hljs-built_in">BOOL</span>)webView:(<span class="hljs-built_in">UIWebView</span> *)webView shouldStartLoadWithRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request navigationType:(<span class="hljs-built_in">UIWebViewNavigationType</span>)navigationType &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, __FUNCTION__);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br><span class="hljs-comment">// 开始load</span><br>- (<span class="hljs-keyword">void</span>)webViewDidStartLoad:(<span class="hljs-built_in">UIWebView</span> *)webView &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, __FUNCTION__);<br>&#125;<br><br><span class="hljs-comment">// load完成</span><br>- (<span class="hljs-keyword">void</span>)webViewDidFinishLoad:(<span class="hljs-built_in">UIWebView</span> *)webView &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, __FUNCTION__);<br>&#125;<br><br><span class="hljs-comment">// load失败</span><br>- (<span class="hljs-keyword">void</span>)webView:(<span class="hljs-built_in">UIWebView</span> *)webView didFailLoadWithError:(<span class="hljs-built_in">NSError</span> *)error &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, __FUNCTION__);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="关键词"><a href="#关键词" class="headerlink" title="关键词"></a><a href="#%E5%85%B3%E9%94%AE%E8%AF%8D" title="关键词"></a>关键词</h2><ol>
<li> 属于 App 占用内存，内存消耗过大可能导致 app 崩溃。</li>
<li> 不如 WKWebView 灵活，提供的 delegate 回调方法很少。</li>
</ol>
<p>加载 HTML，NSData 与 UIWebView 一致。</p>
<p>独立的进程，network loading 和 ui rendering 多进程同时允许，类似 Chrome。所以 App 的内存消耗大幅下降，而其他进程的内存消耗增加。</p>
<p>内存消耗过大，UIWebView 会导致 app 被杀死，而 WKWebView 的 web content process 被杀死则会出现白屏。</p>
<p>有 WKNavigationDelegate 和 WKUIDelegate 两个。</p>
<p>alert 弹窗：实现 WKUIDelegate 协议的 runJavaScriptAlertPanelWithMessage 方法。</p>
<p>confirm 弹窗：实现 WKUIDelegate 协议的 runJavaScriptConfirmPanelWithMessage 方法。</p>
<h2 id="WKWebViewConfiguration"><a href="#WKWebViewConfiguration" class="headerlink" title="WKWebViewConfiguration"></a><a href="#WKWebViewConfiguration" title="WKWebViewConfiguration"></a>WKWebViewConfiguration</h2><p>使用 WKWebView 的默认初始化方法：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm">- (instance<span class="hljs-keyword">type</span>)initWithFrame:(<span class="hljs-type">CGRect</span>)frame configuration:(<span class="hljs-type">WKWebViewConfiguration</span> *)configuration;<br></code></pre></td></tr></table></figure>

<p>会将 configuration 对象复制一份，之后再去修改 configuration 则不生效。</p>
<h2 id="WKNavigationDelegate"><a href="#WKNavigationDelegate" class="headerlink" title="WKNavigationDelegate"></a><a href="#WKNavigationDelegate" title="WKNavigationDelegate"></a>WKNavigationDelegate</h2><p>自定义 webView 接受、加载、完成请求等过程的行为。</p>
<ul>
<li>  WKNavigation 对象包含了跟踪页面加载过程的信息。</li>
<li>  WKNavigationAction 对象包含了可能导致一次加载的操作的信息，用于制定策略决策。</li>
<li>  WKNavigationResponse 对象包含用于制定策略决策的浏览响应信息</li>
</ul>
<p>关键的，与 UIWebView 不同的是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/*! A class conforming to the WKNavigationDelegate protocol can provide</span><br><span class="hljs-comment"> methods for tracking progress for main frame navigations and for deciding</span><br><span class="hljs-comment"> policy for main frame and subframe navigations.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">// MARK: 拦截URL</span><br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Decides whether to allow or cancel a navigation.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> navigationAction Descriptive information about the action</span><br><span class="hljs-comment"> triggering the navigation request.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> decisionHandler The decision handler to call to allow or cancel the</span><br><span class="hljs-comment"> navigation. The argument is one of the constants of the enumerated type WKNavigationActionPolicy.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> If you do not implement this method, the web view will load the request or, if appropriate, forward it to another application.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 接收到响应后, 如何处理(是否跳转, 是否拦截URL等)</span><br><span class="hljs-comment">// 调用decisionHandler(WKNavigationActionPolicyAllow);则允许跳转</span><br><span class="hljs-comment">// 调用decisionHandler(WKNavigationActionPolicyCancel);即不允许跳转</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(<span class="hljs-keyword">void</span> (^)(WKNavigationActionPolicy))decisionHandler &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>    <span class="hljs-comment">// 该方法实现了, 则必须调用decisionHandler.</span><br>    <br>    NSURL *url = navigationAction.request.URL;<br>    <br>    <span class="hljs-keyword">if</span> ([url.absoluteString isEqualToString:@<span class="hljs-string">&quot;about:blank&quot;</span>]) &#123;<br>        decisionHandler(WKNavigationActionPolicyAllow);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    NSString *scheme = [url scheme];<br>    <br>    NSURL *docUrl = navigationAction.request.mainDocumentURL;<br>    NSURL *urlOfBundleFilePrefix = [docUrl URLByDeletingLastPathComponent];<br>    NSString *route = [url.absoluteString stringByReplacingOccurrencesOfString:urlOfBundleFilePrefix.absoluteString withString:@<span class="hljs-string">&quot;&quot;</span>];<br>    <br>    <br>    <span class="hljs-keyword">if</span> ([route containsString:@<span class="hljs-string">&quot;actionOC_JS://&quot;</span>]) &#123;<br>        [<span class="hljs-built_in">self</span> routeJS_OC_Action:route];<br>        <br>        decisionHandler(WKNavigationActionPolicyCancel);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    NSString *host = [url host];<br>    <br>    NSLog(@<span class="hljs-string">&quot;comes from %@ %@&quot;</span>, scheme, host);<br>    <br>    <span class="hljs-keyword">if</span> ([host containsString:@<span class="hljs-string">&quot;baidu&quot;</span>]) &#123;<br>        decisionHandler(WKNavigationActionPolicyCancel);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    decisionHandler(WKNavigationActionPolicyAllow);<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Decides whether to allow or cancel a navigation after its</span><br><span class="hljs-comment"> response is known.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> navigationResponse Descriptive information about the navigation</span><br><span class="hljs-comment"> response.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> decisionHandler The decision handler to call to allow or cancel the</span><br><span class="hljs-comment"> navigation. The argument is one of the constants of the enumerated type WKNavigationResponsePolicy.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> If you do not implement this method, the web view will allow the response, if the web view can show it.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//- (void)webView:(WKWebView *)webView decidePolicyForNavigationResponse:(WKNavigationResponse *)navigationResponse decisionHandler:(void (^)(WKNavigationResponsePolicy))decisionHandler &#123;</span><br><span class="hljs-comment">//    NSLog(@&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;, __FUNCTION__);</span><br><span class="hljs-comment">//&#125;</span><br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Invoked when a main frame navigation starts.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> navigation The navigation.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 页面开始加载</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView didStartProvisionalNavigation:(null_unspecified WKNavigation *)navigation &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Invoked when a server redirect is received for the main</span><br><span class="hljs-comment"> frame.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> navigation The navigation.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 接收到服务器的重定向</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView didReceiveServerRedirectForProvisionalNavigation:(null_unspecified WKNavigation *)navigation &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Invoked when an error occurs while starting to load data for</span><br><span class="hljs-comment"> the main frame.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> navigation The navigation.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> error The error that occurred.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 页面加载失败</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView didFailProvisionalNavigation:(null_unspecified WKNavigation *)navigation withError:(NSError *)<span class="hljs-built_in">error</span> &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>    NSLog(@<span class="hljs-string">&quot;error: %@&quot;</span>, <span class="hljs-built_in">error</span>);<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Invoked when content starts arriving for the main frame.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> navigation The navigation.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 跳转已经完成, 页面内容开始到达并展示</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView didCommitNavigation:(null_unspecified WKNavigation *)navigation &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Invoked when a main frame navigation completes.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> navigation The navigation.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 页面跳转完成</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView didFinishNavigation:(null_unspecified WKNavigation *)navigation &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Invoked when an error occurs during a committed main frame</span><br><span class="hljs-comment"> navigation.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> navigation The navigation.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> error The error that occurred.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 页面跳转失败</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView didFailNavigation:(null_unspecified WKNavigation *)navigation withError:(NSError *)<span class="hljs-built_in">error</span> &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Invoked when the web view needs to respond to an authentication challenge.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view that received the authentication challenge.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> challenge The authentication challenge.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> completionHandler The completion handler you must invoke to respond to the challenge. The</span><br><span class="hljs-comment"> disposition argument is one of the constants of the enumerated type</span><br><span class="hljs-comment"> NSURLSessionAuthChallengeDisposition. When disposition is NSURLSessionAuthChallengeUseCredential,</span><br><span class="hljs-comment"> the credential argument is the credential to use, or nil to indicate continuing without a</span><br><span class="hljs-comment"> credential.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> If you do not implement this method, the web view will respond to the authentication challenge with the NSURLSessionAuthChallengeRejectProtectionSpace disposition.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//- (void)webView:(WKWebView *)webView didReceiveAuthenticationChallenge:(NSURLAuthenticationChallenge *)challenge completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition disposition, NSURLCredential * _Nullable credential))completionHandler &#123;</span><br><span class="hljs-comment">//    NSLog(@&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;, __FUNCTION__);</span><br><span class="hljs-comment">//&#125;</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> 这个方法比较关键，web content process因内存消耗过大被杀死，则此回调会触发。在其中可以对webView进行reload操作。</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Invoked when the web view&#x27;s web content process is terminated.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view whose underlying web content process was terminated.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-keyword">void</span>)webViewWebContentProcessDidTerminate:(WKWebView *)webView &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 在decidePolicyForNavigationAction方法中,</span><br><span class="hljs-comment"> 根据navigationAction的一些参数, 解析出对应的action和参数, 执行即可.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> 对于这些action:</span><br><span class="hljs-comment"> 若调用iOS系统的一些接口, 则over.</span><br><span class="hljs-comment"> 若准备一些参数, 再传递给JS中的函数, 则依然需要调用evaluateJavaScript方法.</span><br><span class="hljs-comment"> */</span><br>- (void)routeJS_OC_Action:(<span class="hljs-symbol">NSString</span> *)route &#123;<br>    <span class="hljs-symbol">NSString</span> *action = [route stringByReplacingOccurrencesOfString:@<span class="hljs-string">&quot;actionOC_JS://&quot;</span> withString:@<span class="hljs-string">&quot;&quot;</span>];<br>    if ([action containsString:@<span class="hljs-string">&quot;setColor&quot;</span>]) &#123;<br>        <span class="hljs-symbol">NSString</span> *paramStr = [action stringByReplacingOccurrencesOfString:@<span class="hljs-string">&quot;setColor?&quot;</span> withString:@<span class="hljs-string">&quot;&quot;</span>];<br>        <span class="hljs-symbol">NSArray</span> *params = [paramStr componentsSeparatedByString:@<span class="hljs-string">&quot;&amp;&quot;</span>];<br>        <br>        <span class="hljs-symbol">NSMutableDictionary</span> *colorDic = [<span class="hljs-symbol">NSMutableDictionary</span> dictionary];<br>        for (<span class="hljs-symbol">NSString</span> *colorStr in params) &#123;<br>            <span class="hljs-symbol">NSArray</span> *key_value = [colorStr componentsSeparatedByString:@<span class="hljs-string">&quot;=&quot;</span>];<br>            [colorDic setObject:key_value[<span class="hljs-number">1</span>] forKey:key_value[<span class="hljs-number">0</span>]];<br>        &#125;<br>        <span class="hljs-symbol">CGFloat</span> r = [[colorDic objectForKey:@<span class="hljs-string">&quot;r&quot;</span>] floatValue];<br>        <span class="hljs-symbol">CGFloat</span> g = [[colorDic objectForKey:@<span class="hljs-string">&quot;g&quot;</span>] floatValue];<br>        <span class="hljs-symbol">CGFloat</span> b = [[colorDic objectForKey:@<span class="hljs-string">&quot;b&quot;</span>] floatValue];<br>        <span class="hljs-symbol">CGFloat</span> a = [[colorDic objectForKey:@<span class="hljs-string">&quot;a&quot;</span>] floatValue];<br><br>        <span class="hljs-symbol">UIColor</span> *color = [<span class="hljs-symbol">UIColor</span> colorWithRed:r/<span class="hljs-number">255.0</span> green:g/<span class="hljs-number">255.0</span> blue:b/<span class="hljs-number">255.0</span> alpha:a];<br>        [self p_actionSetColor:color];<br>    &#125; else if ([action containsString:@<span class="hljs-string">&quot;getLocation&quot;</span>]) &#123;<br>        [self p_actionGetLocation];<br>    &#125; else if ([action containsString:@<span class="hljs-string">&quot;share&quot;</span>]) &#123;<br>        [self p_actionShare];<br>    &#125; else if ([action containsString:@<span class="hljs-string">&quot;scan&quot;</span>]) &#123;<br>        <br>    &#125; else if ([action containsString:@<span class="hljs-string">&quot;shake&quot;</span>]) &#123;<br>        <br>    &#125; else if ([action containsString:@<span class="hljs-string">&quot;pay&quot;</span>]) &#123;<br>    <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="WKUIDelegate"><a href="#WKUIDelegate" class="headerlink" title="WKUIDelegate"></a><a href="#WKUIDelegate" title="WKUIDelegate"></a>WKUIDelegate</h2><p>提供为网页展示 native 用户界面的方法。WebView 用户界面通过实现这个协议来控制新窗口的打开，增强用户单击元素时显示的默认菜单项的表现，并执行其他用户界面相关的任务。这些方法可以通过处理 JavaScript 或其他插件内容来调用。默认每个 WebView 一个窗口，如果需要实现一个非常规用户界面，需要依靠 WKUIDelegate 来实现。</p>
<p>关键的，与 UIWebView 不同的是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/*! A class conforming to the WKUIDelegate protocol provides methods for</span><br><span class="hljs-comment"> presenting native UI on behalf of a webpage.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Creates a new web view.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> configuration The configuration to use when creating the new web</span><br><span class="hljs-comment"> view.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> navigationAction The navigation action causing the new web view to</span><br><span class="hljs-comment"> be created.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> windowFeatures Window features requested by the webpage.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@result</span> A new web view or nil.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> The web view returned must be created with the specified configuration. WebKit will load the request in the returned web view.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> If you do not implement this method, the web view will cancel the navigation.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//- (nullable WKWebView *)webView:(WKWebView *)webView createWebViewWithConfiguration:(WKWebViewConfiguration *)configuration forNavigationAction:(WKNavigationAction *)navigationAction windowFeatures:(WKWindowFeatures *)windowFeatures;</span><br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Notifies your app that the DOM window object&#x27;s close() method completed successfully.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> Your app should remove the web view from the view hierarchy and update</span><br><span class="hljs-comment"> the UI as needed, such as by closing the containing browser tab or window.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-keyword">void</span>)webViewDidClose:(WKWebView *)webView &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Displays a JavaScript alert panel.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> message The message to display.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> frame Information about the frame whose JavaScript initiated this</span><br><span class="hljs-comment"> call.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> completionHandler The completion handler to call after the alert</span><br><span class="hljs-comment"> panel has been dismissed.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> For user security, your app should call attention to the fact</span><br><span class="hljs-comment"> that a specific website controls the content in this panel. A simple forumla</span><br><span class="hljs-comment"> for identifying the controlling website is frame.request.URL.host.</span><br><span class="hljs-comment"> The panel should have a single OK button.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> If you do not implement this method, the web view will behave as if the user selected the OK button.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 弹出警告框</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView runJavaScriptAlertPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(<span class="hljs-keyword">void</span> (^)(<span class="hljs-keyword">void</span>))completionHandler &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>    <br>    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@<span class="hljs-string">&quot;Alert&quot;</span> message:message preferredStyle:UIAlertControllerStyleAlert];<br>    [alert addAction:[UIAlertAction actionWithTitle:@<span class="hljs-string">&quot;OK&quot;</span> style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) &#123;<br>        completionHandler();<br>    &#125;]];<br>    <br>    [<span class="hljs-built_in">self</span> presentViewController:alert animated:YES completion:nil];<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Displays a JavaScript confirm panel.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> message The message to display.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> frame Information about the frame whose JavaScript initiated this call.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> completionHandler The completion handler to call after the confirm</span><br><span class="hljs-comment"> panel has been dismissed. Pass YES if the user chose OK, NO if the user</span><br><span class="hljs-comment"> chose Cancel.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> For user security, your app should call attention to the fact</span><br><span class="hljs-comment"> that a specific website controls the content in this panel. A simple forumla</span><br><span class="hljs-comment"> for identifying the controlling website is frame.request.URL.host.</span><br><span class="hljs-comment"> The panel should have two buttons, such as OK and Cancel.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> If you do not implement this method, the web view will behave as if the user selected the Cancel button.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 弹出确认框</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView runJavaScriptConfirmPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(<span class="hljs-keyword">void</span> (^)(<span class="hljs-keyword">BOOL</span> result))completionHandler &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>    <br>    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@<span class="hljs-string">&quot;Confirm&quot;</span> message:message preferredStyle:UIAlertControllerStyleAlert];<br>    [alert addAction:[UIAlertAction actionWithTitle:@<span class="hljs-string">&quot;OK&quot;</span> style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) &#123;<br>        completionHandler(YES);<br>    &#125;]];<br>    <br>    [<span class="hljs-built_in">self</span> presentViewController:alert animated:YES completion:nil];<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Displays a JavaScript text input panel.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> message The message to display.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> defaultText The initial text to display in the text entry field.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> frame Information about the frame whose JavaScript initiated this call.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> completionHandler The completion handler to call after the text</span><br><span class="hljs-comment"> input panel has been dismissed. Pass the entered text if the user chose</span><br><span class="hljs-comment"> OK, otherwise nil.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> For user security, your app should call attention to the fact</span><br><span class="hljs-comment"> that a specific website controls the content in this panel. A simple forumla</span><br><span class="hljs-comment"> for identifying the controlling website is frame.request.URL.host.</span><br><span class="hljs-comment"> The panel should have two buttons, such as OK and Cancel, and a field in</span><br><span class="hljs-comment"> which to enter text.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> If you do not implement this method, the web view will behave as if the user selected the Cancel button.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 弹出输入框</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView runJavaScriptTextInputPanelWithPrompt:(NSString *)prompt defaultText:(nullable NSString *)defaultText initiatedByFrame:(WKFrameInfo *)frame completionHandler:(<span class="hljs-keyword">void</span> (^)(NSString * _Nullable result))completionHandler &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>&#125;<br><br><span class="hljs-comment">#if TARGET_OS_IPHONE</span><br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Allows your app to determine whether or not the given element should show a preview.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> elementInfo The elementInfo for the element the user has started touching.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> To disable previews entirely for the given element, return NO. Returning NO will prevent</span><br><span class="hljs-comment"> webView:previewingViewControllerForElement:defaultActions: and webView:commitPreviewingViewController:</span><br><span class="hljs-comment"> from being invoked.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> This method will only be invoked for elements that have default preview in WebKit, which is</span><br><span class="hljs-comment"> limited to links. In the future, it could be invoked for additional elements.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// 是否预览</span><br>- (<span class="hljs-keyword">BOOL</span>)webView:(WKWebView *)webView shouldPreviewElement:(WKPreviewElementInfo *)elementInfo &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>    <span class="hljs-keyword">return</span> YES;<br>&#125;<br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Allows your app to provide a custom view controller to show when the given element is peeked.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> elementInfo The elementInfo for the element the user is peeking.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> defaultActions An array of the actions that WebKit would use as previewActionItems for this element by</span><br><span class="hljs-comment"> default. These actions would be used if allowsLinkPreview is YES but these delegate methods have not been</span><br><span class="hljs-comment"> implemented, or if this delegate method returns nil.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@discussion</span> Returning a view controller will result in that view controller being displayed as a peek preview.</span><br><span class="hljs-comment"> To use the defaultActions, your app is responsible for returning whichever of those actions it wants in your</span><br><span class="hljs-comment"> view controller&#x27;s implementation of -previewActionItems.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> Returning nil will result in WebKit&#x27;s default preview behavior. webView:commitPreviewingViewController: will only be invoked</span><br><span class="hljs-comment"> if a non-nil view controller was returned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//- (nullable UIViewController *)webView:(WKWebView *)webView previewingViewControllerForElement:(WKPreviewElementInfo *)elementInfo defaultActions:(NSArray&lt;id &lt;WKPreviewActionItem&gt;&gt; *)previewActions API_AVAILABLE(ios(10.0))</span><br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Allows your app to pop to the view controller it created.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> previewingViewController The view controller that is being popped.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-keyword">void</span>)webView:(WKWebView *)webView commitPreviewingViewController:(UIViewController *)previewingViewController &#123;<br>    NSLog(@<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; %s&quot;</span>, <span class="hljs-keyword">__FUNCTION__</span>);<br>&#125;<br><br><span class="hljs-comment">#endif // TARGET_OS_IPHONE</span><br><br><span class="hljs-comment">#if !TARGET_OS_IPHONE</span><br><br><span class="hljs-comment">/*! <span class="hljs-doctag">@abstract</span> Displays a file upload panel.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> webView The web view invoking the delegate method.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> parameters Parameters describing the file upload control.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> frame Information about the frame whose file upload control initiated this call.</span><br><span class="hljs-comment"> <span class="hljs-doctag">@param</span> completionHandler The completion handler to call after open panel has been dismissed. Pass the selected URLs if the user chose OK, otherwise nil.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> If you do not implement this method, the web view will behave as if the user selected the Cancel button.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//- (void)webView:(WKWebView *)webView runOpenPanelWithParameters:(WKOpenPanelParameters *)parameters initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(NSArray&lt;NSURL *&gt; * _Nullable URLs))completionHandler API_AVAILABLE(macosx(10.12));</span><br><br><span class="hljs-comment">#endif</span><br></code></pre></td></tr></table></figure>

<h2 id="关键词-1"><a href="#关键词-1" class="headerlink" title="关键词"></a><a href="#%E5%85%B3%E9%94%AE%E8%AF%8D-1" title="关键词"></a>关键词</h2><ol>
<li> 相比 UIWebView 的控制粒度更细。在服务端请求响应之后，会询问是否载入内容到当前 WKWebView。而 UIWebView 是直接载入。URL 的 content 下载完成，会询问是否允许下载的内容载入。</li>
<li> 多了一个重定向的通知，WKWebView 进程退出时有个 terminate 的回调方法。</li>
<li> 不占用 App 自身内存。但 web content process 的内存带来了白屏等问题。</li>
<li> alert、conform 等视图需要通过 WKUIDelegate 协议来接收通知，iOS 原生执行。</li>
<li> Native-&gt;JS 通信，WKWebView 是异步的，而 UIWebView 是同步的。</li>
<li> cookie 机制比较复杂。</li>
</ol>
<p>支持 KVO 的一些属性：</p>
<ol>
<li> title</li>
<li> URL</li>
<li> estimatedProgress</li>
<li> hasOnlySecureContent，页面中的所有资源是否都是通过安全链接加载的？</li>
<li> loading</li>
</ol>
<p>其中，title、URL、loading 通常可以用来检测是否加载成功，例如是否出现 webView 白屏等。</p>
<p>iOS 模拟器进入对应的 WebView 界面，打开 Safari，打开开发菜单即可。注意，调试时候，App 不需要处于 debugging 中。</p>
<p>iOS 真机调试 WebView，则要先 <strong><em>设置 -&gt;Safari 浏览器 -&gt; 高级 -&gt; 打开 JavaScript 和 Web 检查器</em></strong> , 同时使用 Debug 证书。</p>
<p>管理与特定的 WKWebsiteDataStore 关联的 HTTP cookie 的对象:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-keyword">void</span>)getAllCookies:(<span class="hljs-keyword">void</span> (^)(<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSHTTPCookie</span> *&gt; *))completionHandler;<br>- (<span class="hljs-keyword">void</span>)setCookie:(<span class="hljs-built_in">NSHTTPCookie</span> *)cookie completionHandler:(<span class="hljs-keyword">void</span> (^)(<span class="hljs-keyword">void</span>))completionHandler;<br>- (<span class="hljs-keyword">void</span>)deleteCookie:(<span class="hljs-built_in">NSHTTPCookie</span> *)cookie completionHandler:(<span class="hljs-keyword">void</span> (^)(<span class="hljs-keyword">void</span>))completionHandler;<br>- (<span class="hljs-keyword">void</span>)addObserver:(<span class="hljs-keyword">id</span>&lt;<span class="hljs-built_in">WKHTTPCookieStoreObserver</span>&gt;)observer;<br>- (<span class="hljs-keyword">void</span>)removeObserver:(<span class="hljs-keyword">id</span>&lt;<span class="hljs-built_in">WKHTTPCookieStoreObserver</span>&gt;)observer;<br>- (<span class="hljs-keyword">void</span>)cookiesDidChangeInCookieStore:(<span class="hljs-built_in">WKHTTPCookieStore</span> *)cookieStore;<br></code></pre></td></tr></table></figure>

<p>注意，cookie 可以用来监控。</p>
<p>JSCore 跟 Google 的 V8 引擎类似，都是用于解释执行 JavaScript 代码的核心引擎。</p>
<p>JSVirtualMachine，JSContext，JSValue，JSExport，evaluateJavaScript。</p>
<p>以下都是一对多：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">JS</span> <span class="hljs-comment">VM</span> --<span class="hljs-literal">-</span>&gt; <span class="hljs-comment">JSContext</span> --<span class="hljs-literal">-</span>&gt; <span class="hljs-comment">JSValue</span><br></code></pre></td></tr></table></figure>

<h2 id="JSVirtualMachine"><a href="#JSVirtualMachine" class="headerlink" title="JSVirtualMachine"></a><a href="#JSVirtualMachine" title="JSVirtualMachine"></a>JSVirtualMachine</h2><p>为 JS 代码的运行提供一个虚拟机环境。一个 JS VM 只能执行一个线程，若要多线程，则需要创建多个 JS VM。跟 JS 的单线程模型是什么关系？</p>
<p>每个 JS VM 都有自己的 GC，多个 JS VM 之间的对象无法传递。</p>
<h2 id="JSContext"><a href="#JSContext" class="headerlink" title="JSContext"></a><a href="#JSContext" title="JSContext"></a>JSContext</h2><p>是 JS 运行环境的上下文，负责 Native 和 JS 的数据传递</p>
<h2 id="JSValue"><a href="#JSValue" class="headerlink" title="JSValue"></a><a href="#JSValue" title="JSValue"></a>JSValue</h2><p>JS 的值对象，提供 JS 的原始值对象与 Native 对象的转换方式。</p>
<h2 id="Native-gt-JS"><a href="#Native-gt-JS" class="headerlink" title="Native-&gt;JS"></a><a href="#Native-gt-JS" title="Native-&gt;JS"></a>Native-&gt;JS</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">[webView evaluateJavaScript:jsString]<br></code></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[jsContext evaluateScript:jsString]</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>使用 toString，toNumber，toDictionary 从 JSValue 中取出对应的 Native 对象。</p>
<p>若要使用 JS 的函数对象，则使用 callWithArguments 方法:</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">[<span class="hljs-built_in">context</span> evaluateString:@<span class="hljs-string">&quot;function addition(x,y) &#123;return x+ y&#125;&quot;</span>];<br><span class="hljs-keyword">JSValue </span>*<span class="hljs-keyword">addition </span>= <span class="hljs-built_in">context</span>[@<span class="hljs-string">&quot;addition&quot;</span>];<br><span class="hljs-keyword">JSValue </span>*resultValue = [<span class="hljs-keyword">addition </span>callWithArguments:@[@(<span class="hljs-number">4</span>), @(<span class="hljs-number">8</span>)]];<br>[resultValue toNumber];<br></code></pre></td></tr></table></figure>

<p>Weex 中类似：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">- (JSValue *)callJSMethod:(NSString *)<span class="hljs-function"><span class="hljs-keyword">method</span> <span class="hljs-title">args</span>:</span>(NSArray *)args <span class="hljs-comment">&#123;</span><br><span class="hljs-comment">    return [[_jsContext globalObject] invokeMethod:method withArguments:args];</span><br><span class="hljs-comment">&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="JS-gt-Native"><a href="#JS-gt-Native" class="headerlink" title="JS-&gt;Native"></a><a href="#JS-gt-Native" title="JS-&gt;Native"></a>JS-&gt;Native</h2><p>使用 block：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-built_in">context</span>[@<span class="hljs-string">&quot;subtraction&quot;</span>] = ^(int x, int y) &#123;<br>    return x + y;<br>&#125;<br><span class="hljs-keyword">JSValue </span>*<span class="hljs-keyword">subValue </span>= [<span class="hljs-built_in">context</span> evaluateScript:@<span class="hljs-string">&quot;subtraction(4,8);&quot;</span>];<br>[<span class="hljs-keyword">subValue </span>toNumber];<br></code></pre></td></tr></table></figure>

<p>JS 调用 Native 代码，是通过 block 或 closure 来实现的。</p>
<h2 id="JSExport"><a href="#JSExport" class="headerlink" title="JSExport"></a><a href="#JSExport" title="JSExport"></a>JSExport</h2><p>JSExport 协议，可以将 Native 对象 export 到 JSContext 中。</p>
<p>自定义一个 protocol 继承 JSExport 协议，将 OC 对象传入 JS 中。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@protocol</span> PersonJSExport &lt;JSExport&gt;<br><br><span class="hljs-variable">@end</span><br><br>jsContext[@<span class="hljs-string">&quot;Person&quot;</span>] = [Person class];<br><span class="hljs-selector-attr">[jsContext evaluateScript:@<span class="hljs-string">&quot;var personWithName = function(name) &#123; var person = Person.persionWithName(name); return person; &#125;&quot;</span>]</span>;<br><span class="hljs-selector-attr">[[jsContext objectForKeyedSubscript:@<span class="hljs-string">&quot;persionWithName&quot;</span>]</span> <span class="hljs-selector-tag">callWithArguments</span>:@<span class="hljs-selector-attr">[@<span class="hljs-string">&quot;Chris&quot;</span>]</span>];<br></code></pre></td></tr></table></figure>

<p>这里，将 OC 的类 Person 继承 JSExport 协议，然后封装一个函数 personWithName 来调用该 OC 类的初始化代码。<br>通过 objectForKeyedSubscript 来取出 JS 中的函数，使用 callWithArguments: 来执行。</p>
<h2 id="JSPatch-原理"><a href="#JSPatch-原理" class="headerlink" title="JSPatch 原理"></a><a href="#JSPatch%E5%8E%9F%E7%90%86" title="JSPatch原理"></a>JSPatch 原理</h2><p>除了 block 和 JSExport 之外，还可以使用 JSContext 和 JSValue 的类型转换和 OC 的 runtime 消息转发机制实现动态调用，巧妙避开 JSExport 协议，即 JSPatch 的实现原理。</p>
<h2 id="JavaScriptCore-的组成"><a href="#JavaScriptCore-的组成" class="headerlink" title="JavaScriptCore 的组成"></a><a href="#JavaScriptCore%E7%9A%84%E7%BB%84%E6%88%90" title="JavaScriptCore的组成"></a>JavaScriptCore 的组成</h2><p>真实的 JavaScript 虚拟机，包含了解释器和运行时。</p>
<p>解释器将高级的脚本语言编译成字节码，runtime 用来管理 runtime 的内存空间。</p>
<p>JSCore 内部由 Parse，Interpreter，Compiler，GC 组成。</p>
<h2 id="解释执行"><a href="#解释执行" class="headerlink" title="解释执行"></a><a href="#%E8%A7%A3%E9%87%8A%E6%89%A7%E8%A1%8C" title="解释执行"></a>解释执行</h2><p>由 Parser 进行词法分析，语法分析，生成字节码。</p>
<p>Interpreter 进行解释执行。先有 LLInt（Low Level Interpreter）来执行 Parser 生成的字节码，JSCore 会对运行频次高的函数或循环进行优化。</p>
<p>优化器有 Baseline JIT，DFG JIT，FTL JIT 等。</p>
<h2 id="执行-js-代码"><a href="#执行-js-代码" class="headerlink" title="执行 js 代码"></a><a href="#%E6%89%A7%E8%A1%8Cjs%E4%BB%A3%E7%A0%81" title="执行js代码"></a>执行 js 代码</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-keyword">void</span>)evaluateJavaScript:(<span class="hljs-built_in">NSString</span> *)javaScriptString completionHandler:(<span class="hljs-keyword">void</span> (^)(<span class="hljs-keyword">id</span>, <span class="hljs-built_in">NSError</span> *error))completionHandler;<br></code></pre></td></tr></table></figure>

<p>注意，其 completionHandler 是在主线程执行的。</p>
<h2 id="WKProcessPool"><a href="#WKProcessPool" class="headerlink" title="WKProcessPool"></a><a href="#WKProcessPool" title="WKProcessPool"></a>WKProcessPool</h2><p>Web Content 的进程池。WKWebView 对象初始化的时候，会从该进程池中获取一个 Web Content 进程对象。</p>
<h2 id="截图"><a href="#截图" class="headerlink" title="截图"></a><a href="#%E6%88%AA%E5%9B%BE" title="截图"></a>截图</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-keyword">void</span>)takeSnapshotWithConfiguration:(<span class="hljs-built_in">WKSnapshotConfiguration</span> *)snapshotConfiguration completionHandler:(<span class="hljs-keyword">void</span> (^)(<span class="hljs-built_in">UIImage</span> *snapshotImage, <span class="hljs-built_in">NSError</span> *error))completionHandler;<br></code></pre></td></tr></table></figure>

<p>可使用 WKSnapshotConfiguration 来自定义 webView 截图区域。</p>
<h2 id="WKUserContentController"><a href="#WKUserContentController" class="headerlink" title="WKUserContentController"></a><a href="#WKUserContentController" title="WKUserContentController"></a>WKUserContentController</h2><p>提供了向 WKWebView 发送 JS 消息或者注入 JS 脚本的方法。</p>
<p>一个 WKUserScript 对象代表了一个可以被注入网页中的脚本。脚本注入的时机，只能通过 WKUserScriptInjectionTime 枚举来设置。其包含 WKUserScriptInjectionTimeAtDocumentStart 和 WKUserScriptInjectionTimeAtDocumentEnd。</p>
<h2 id="WKScriptMessageHandler"><a href="#WKScriptMessageHandler" class="headerlink" title="WKScriptMessageHandler"></a><a href="#WKScriptMessageHandler" title="WKScriptMessageHandler"></a>WKScriptMessageHandler</h2><p>实现该协议的类，可以接收来自网页的 JS 调用方法。</p>
<p>WKScriptMessage 对象即包含了一个 JS 消息的相关信息。其属性 id body 只能是对象类型。</p>
<h2 id="WKWebsiteDataStore"><a href="#WKWebsiteDataStore" class="headerlink" title="WKWebsiteDataStore"></a><a href="#WKWebsiteDataStore" title="WKWebsiteDataStore"></a>WKWebsiteDataStore</h2><p>如果一个 WebView 关联了一个非持久化的 WKWebsiteDataStore，将不会有数据被写入到文件系统<br>该特性可以用来实现隐私浏览。<br>同样可以通过设置 configuration 来设置无痕模式。</p>
<p>一个 WKWebsiteDataStore 对象代表了被网页使用的各种类型的数据。包括 cookies，磁盘文件，内存缓存以及持久化数据如 WebSQL，IndexedDB 数据库，local storage。</p>
<h2 id="WKURLSchemeHandler"><a href="#WKURLSchemeHandler" class="headerlink" title="WKURLSchemeHandler"></a><a href="#WKURLSchemeHandler" title="WKURLSchemeHandler"></a>WKURLSchemeHandler</h2><p>用来处理 WebKit 无法处理的 URL Scheme 类型的资源</p>
<p>加载特定资源的时候使用。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-keyword">void</span>)webView:(<span class="hljs-built_in">WKWebView</span> *)webView startURLSchemeTask:(<span class="hljs-keyword">id</span>&lt;<span class="hljs-built_in">WKURLSchemeTask</span>&gt;)urlSchemeTask;<br>- (<span class="hljs-keyword">void</span>)webView:(<span class="hljs-built_in">WKWebView</span> *)webView stopURLSchemeTask:(<span class="hljs-keyword">id</span>&lt;<span class="hljs-built_in">WKURLSchemeTask</span>&gt;)urlSchemeTask;<br></code></pre></td></tr></table></figure>

<p>WKURLSchemeTask 即用来加载资源的任务。</p>
<h2 id="使用-KVO-来监控-load-进度"><a href="#使用-KVO-来监控-load-进度" class="headerlink" title="使用 KVO 来监控 load 进度"></a><a href="#%E4%BD%BF%E7%94%A8KVO%E6%9D%A5%E7%9B%91%E6%8E%A7load%E8%BF%9B%E5%BA%A6" title="使用KVO来监控load进度"></a>使用 KVO 来监控 load 进度</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">[webView addObserver:<span class="hljs-keyword">self</span> forKeyPath:<span class="hljs-string">@&quot;loading&quot;</span> options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span> context:<span class="hljs-literal">nil</span>];<br>[webView addObserver:<span class="hljs-keyword">self</span> forKeyPath:<span class="hljs-string">@&quot;estimatedProgress&quot;</span> options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span> context:<span class="hljs-literal">nil</span>];<br></code></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-keyword">void</span>)observeValueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath ofObject:(<span class="hljs-keyword">id</span>)object change:(<span class="hljs-built_in">NSDictionary</span> *)change context:(<span class="hljs-keyword">void</span> *)context<br>&#123;<br>    <span class="hljs-keyword">if</span> ([keyPath isEqualToString:<span class="hljs-string">@&quot;loading&quot;</span>]) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;loading: %d&quot;</span>, _webView.isLoading);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([keyPath isEqualToString:<span class="hljs-string">@&quot;estimatedProgress&quot;</span>]) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;estimatedProgress: %f&quot;</span>, _webView.estimatedProgress);<br>        <span class="hljs-keyword">self</span>.progressView.progress = _webView.estimatedProgress;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.progressView.progress &gt;= <span class="hljs-number">1.</span>f) &#123;<br>            <span class="hljs-keyword">self</span>.progressView.progress = <span class="hljs-number">0.</span>f;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="查看所有-cookie"><a href="#查看所有-cookie" class="headerlink" title="查看所有 cookie"></a><a href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89cookie" title="查看所有cookie"></a>查看所有 cookie</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus">webView<span class="hljs-selector-class">.configuration</span><span class="hljs-selector-class">.websiteDataStore</span><span class="hljs-selector-class">.httpCookieStore</span><span class="hljs-selector-class">.getAllCookies</span> &#123; cookies <span class="hljs-keyword">in</span><br>    <span class="hljs-keyword">for</span> cookie <span class="hljs-keyword">in</span> cookies &#123;<br>        <span class="hljs-keyword">if</span> cookie<span class="hljs-selector-class">.name</span> == <span class="hljs-string">&quot;authentication&quot;</span> &#123;<br>            self<span class="hljs-selector-class">.webView</span><span class="hljs-selector-class">.configuration</span><span class="hljs-selector-class">.websiteDataStore</span><span class="hljs-selector-class">.httpCookieStore</span><span class="hljs-selector-class">.delete</span>(cookie)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            print(<span class="hljs-string">&quot;\(cookie.name) is set to \(cookie.value)&quot;</span>)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="白屏原因及处理措施"><a href="#白屏原因及处理措施" class="headerlink" title="白屏原因及处理措施"></a><a href="#%E7%99%BD%E5%B1%8F%E5%8E%9F%E5%9B%A0%E5%8F%8A%E5%A4%84%E7%90%86%E6%8E%AA%E6%96%BD" title="白屏原因及处理措施"></a>白屏原因及处理措施</h2><p>详细内容见之前一篇博客 <a target="_blank" rel="noopener" href="https://juejin.im/post/5df213f56fb9a01613801a4f">WKWebView 的一些问题汇总</a> 。</p>
<ul>
<li>  <a target="_blank" rel="noopener" href="https://juejin.im/entry/5975916e518825594d23d777">教你使用 WKWebView 的正确姿势</a></li>
<li>  <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1033743">WKWebView 详解</a></li>
<li>  <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/161">iOS 开发高手课</a></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/webview/">webview</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/webview/">webview</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/03/23/2018-2/%E5%93%88%E5%B8%8C%E8%A1%A8/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">哈希表</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/03/02/2018/%E4%BD%BF%E7%94%A8%20WKWebView%20%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C/">
                        <span class="hidden-mobile">使用 WKWebView 的一些经验</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
